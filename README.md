# üè• Ensurance Pharmacy - Sistema Integrado de Seguros y Farmacia

- Por Pablo Flores Mollinedo
- Sistema completo que integra gesti√≥n de seguros m√©dicos y farmacia, desarrollado con arquitectura de microservicios.

## üìã √çndice

- [üèóÔ∏è Arquitectura del Sistema](#Ô∏è-arquitectura-del-sistema)
- [üåê Configuraci√≥n de Puertos y Ambientes](#-configuraci√≥n-de-puertos-y-ambientes)
- [üîß Instalaci√≥n y Configuraci√≥n](#-instalaci√≥n-y-configuraci√≥n)
- [üöÄ Ejecuci√≥n](#-ejecuci√≥n)
- [üß™ Testing](#-testing)
- [üê≥ Docker](#-docker)
- [üìä Base de Datos](#-base-de-datos)
- [üîó Integraciones](#-integraciones)
- [üìö Documentaci√≥n por Componente](#-documentaci√≥n-por-componente)

---

## üèóÔ∏è Arquitectura del Sistema

### Componentes Principales

| Componente                     | Tecnolog√≠a                | Puerto | Descripci√≥n                               |
| ------------------------------ | ------------------------- | ------ | ----------------------------------------- |
| **Ensurance Frontend**         | Vue 3 + TypeScript + Vite | 5175   | Interface de usuario para seguros m√©dicos |
| **Pharmacy Frontend**          | Vue 3 + Vue CLI           | 8089   | Interface de usuario para farmacia        |
| **Ensurance Backend (backv4)** | Java + HttpServer         | 8081   | API REST para seguros m√©dicos             |
| **Pharmacy Backend (backv5)**  | Java + HttpServer         | 8082   | API REST para farmacia                    |

### Stack Tecnol√≥gico

**Frontend:**

- Vue 3 con Composition API
- TypeScript (Ensurance) / JavaScript (Pharmacy)
- Vite (Ensurance) / Vue CLI (Pharmacy)
- Tailwind CSS / CSS personalizado
- Pinia para gesti√≥n de estado
- Vitest / Jest para testing

**Backend:**

- Java 23 con preview features
- `com.sun.net.httpserver.HttpServer`
- Hibernate ORM
- SQLite (desarrollo) / Oracle (producci√≥n)
- Maven para gesti√≥n de dependencias
- JaCoCo para cobertura de c√≥digo

---

## üåê Configuraci√≥n de Puertos y Ambientes

### üìã Tabla de Puertos por Ambiente

#### üîß DEV (branches: dev, develop, development)

| Servicio               | Tipo    | Puerto   | URL                        |
| ---------------------- | ------- | -------- | -------------------------- |
| **Ensurance Frontend** | **Web** | **3000** | **http://localhost:3000**  |
| **Pharmacy Frontend**  | **Web** | **3001** | **http://localhost:3001**  |
| Ensurance Backend      | API     | 3002     | http://localhost:3002/api  |
| Pharmacy Backend       | API     | 3003     | http://localhost:3003/api2 |

#### üß™ QA (branches: qa, test, testing, staging)

| Servicio               | Tipo    | Puerto   | URL                        |
| ---------------------- | ------- | -------- | -------------------------- |
| **Ensurance Frontend** | **Web** | **4000** | **http://localhost:4000**  |
| **Pharmacy Frontend**  | **Web** | **4001** | **http://localhost:4001**  |
| Ensurance Backend      | API     | 4002     | http://localhost:4002/api  |
| Pharmacy Backend       | API     | 4003     | http://localhost:4003/api2 |

#### üöÄ MAIN (branches: main, master)

| Servicio               | Tipo    | Puerto   | URL                        |
| ---------------------- | ------- | -------- | -------------------------- |
| **Ensurance Frontend** | **Web** | **5175** | **http://localhost:5175**  |
| **Pharmacy Frontend**  | **Web** | **8089** | **http://localhost:8089**  |
| Ensurance Backend      | API     | 8081     | http://localhost:8081/api  |
| Pharmacy Backend       | API     | 8082     | http://localhost:8082/api2 |

### üîß Variables de Entorno por Ambiente

#### DEV Environment

```bash
# Frontend Ensurance (Vite)
VITE_ENSURANCE_API_URL=http://localhost:8081/api
VITE_PHARMACY_API_URL=http://localhost:8082/api2
VITE_IP=localhost

# Frontend Pharmacy (Vue)
VUE_APP_PHARMACY_API_URL=http://localhost:8082/api2
VUE_APP_ENSURANCE_API_URL=http://localhost:8081/api
VUE_APP_IP=localhost

# Backend Variables
SERVER_HOST=0.0.0.0
ENVIRONMENT=dev
NODE_ENV=development
JAVA_OPTS="-Xmx256m -Xms128m -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
```

#### QA Environment

```bash
# Mismas variables base pero con:
ENVIRONMENT=qa
NODE_ENV=test
JAVA_OPTS="-Xmx384m -Xms192m"
TEST_MODE=true
```

#### MAIN Environment

```bash
# Mismas variables base pero con:
ENVIRONMENT=main
NODE_ENV=production
JAVA_OPTS="-Xmx512m -Xms256m"
```

---

## üîß Instalaci√≥n y Configuraci√≥n

### Requisitos del Sistema

- **Node.js** LTS 18+ (para frontends)
- **Java 23** (para backends)
- **Maven 3.8+** (para backends)
- **Python 3** (para scripts de IP)
- **Docker y Docker Compose** (opcional)
- **SQLite3** (para desarrollo local)

### Instalaci√≥n de Dependencias

```bash
# Instalar dependencias de todos los sistemas
./test-runner.sh
# Seleccionar opci√≥n 9: Install all dependencies

# O manualmente:
cd ensurance && npm install && cd ..
cd pharmacy && npm install && cd ..
```

---

## üöÄ Ejecuci√≥n

### Desarrollo con Docker (Recomendado)

#### Despliegue Autom√°tico

```bash
# Detecta autom√°ticamente la rama git y despliega
./deploy.sh auto

# Despliegue espec√≠fico por ambiente
./deploy.sh deploy dev    # Puertos 3000-3003
./deploy.sh deploy qa     # Puertos 4000-4003
./deploy.sh deploy main   # Puertos 5175, 8089, 8081, 8082
```

#### Gesti√≥n de Contenedores

```bash
# Ver estado de todos los ambientes
./deploy.sh status

# Ver logs en tiempo real
./deploy.sh logs dev
./deploy.sh logs qa
./deploy.sh logs main

# Detener ambiente espec√≠fico
./deploy.sh stop dev

# Limpiar todos los contenedores
./deploy.sh clean
```

### Desarrollo Local (Sin Docker)

#### Frontends

```bash
# Ensurance Frontend
cd ensurance
npm run dev
# Disponible en: http://localhost:5173

# Pharmacy Frontend
cd pharmacy
npm run serve
# Disponible en: http://localhost:8080
```

#### Backends

```bash
# Ensurance Backend (backv4)
cd backv4
mvn exec:java -Dexec.mainClass="com.sources.app.App"
# Disponible en: http://localhost:8081/api

# Pharmacy Backend (backv5)
cd backv5
mvn exec:java -Dexec.mainClass="com.sources.app.App"
# Disponible en: http://localhost:8082/api2
```

### Script Unificado de Testing

El proyecto incluye un script bash interactivo para ejecutar tests y coverage:

```bash
./test-runner.sh
```

**Opciones disponibles:**

- **1-4**: Tests de frontend (Ensurance/Pharmacy)
- **5-6**: Tests de backend (BackV5/BackV4)
- **7-8**: Ejecutar todos los sistemas
- **9**: Instalar dependencias
- **10**: An√°lisis SonarQube
- **0**: Salir

---

## üß™ Testing

### Frontend Testing

#### Ensurance (Vitest)

```bash
npm run test        # Modo interactivo
npm run test:run    # Modo headless (CI)
npm run test:ui     # Interfaz UI de Vitest
```

#### Pharmacy (Jest)

```bash
npm run test:unit         # Ejecuta una vez
npm run test:unit:watch   # Observa cambios
npm run test:unit:file    # Archivo espec√≠fico
```

### Backend Testing

#### BackV4 (Ensurance Backend)

```bash
# Oracle (por defecto)
mvn -f backv4 test

# SQLite (desarrollo)
mvn -f backv4 -Psqlite-dev test
mvn -f backv4 -Psqlite-uat test
mvn -f backv4 -Psqlite-prod test

# Test espec√≠fico
mvn -f backv4 -Dtest=TransactionPolicyTest test

# Con logs en consola
mvn -f backv4 -Dsurefire.useFile=false test
```

#### BackV5 (Pharmacy Backend)

```bash
# Tests con cobertura
mvn -f backv5 clean test jacoco:report

# Reporte en: target/site/jacoco/index.html
```

### Cobertura de C√≥digo

```bash
# Generar reportes de cobertura para todos los sistemas
./test-runner.sh
# Seleccionar opci√≥n 8: Run ALL tests with coverage

# SonarQube (requiere servidor local en puerto 9000)
./test-runner.sh
# Seleccionar opci√≥n 10: Run SonarQube analysis
```

---

## üê≥ Docker - Sistema Unificado Multi-Ambiente

El sistema incluye un Dockerfile unificado que ejecuta ambos sistemas (Ensurance y Pharmacy) con configuraci√≥n multi-ambiente que detecta autom√°ticamente la rama git.

### ‚ñ∂Ô∏è Docker Compose por archivo (ejecuci√≥n separada)

Puedes levantar cada archivo `docker-compose` por separado seg√∫n el ambiente o herramientas CI/CD:

```bash
# DEV (puertos 3000-3003)
docker compose -f docker-compose.dev.yml up -d --build
docker compose -f docker-compose.dev.yml logs -f
docker compose -f docker-compose.dev.yml down

# QA (puertos 4000-4003)
docker compose -f docker-compose.qa.yml up -d --build
docker compose -f docker-compose.qa.yml logs -f
docker compose -f docker-compose.qa.yml down

# MAIN/Producci√≥n local (puertos 5175, 8089, 8081, 8082)
docker compose -f docker-compose.main.yml up -d --build
docker compose -f docker-compose.main.yml logs -f
docker compose -f docker-compose.main.yml down

# CI/CD stack (Jenkins, SonarQube, Drone, Docker-in-Docker)
docker compose -f docker-compose.cicd.yml up -d
docker compose -f docker-compose.cicd.yml logs -f
docker compose -f docker-compose.cicd.yml down
```

Accesos r√°pidos del stack CI/CD levantado con `docker-compose.cicd.yml`:

- Jenkins: `http://localhost:8080/jenkins`
- SonarQube: `http://localhost:9000/sonnar` (contexto configurado en `SONAR_WEB_CONTEXT`)
- Drone: `http://localhost:8000` (HTTP) / `https://localhost:8443` (HTTPS)

Notas:

- El servicio `docker` (dind) requiere Docker con privilegios; en Desktop suele funcionar por defecto.
- Jenkins primera ejecuci√≥n: obtener contrase√±a inicial con `docker exec -it jenkins cat /var/jenkins_home/secrets/initialAdminPassword`.
- Los vol√∫menes declarados se crean autom√°ticamente; para borrar datos agrega `-v` al comando `down`.

### üèóÔ∏è Arquitectura del Contenedor

El Dockerfile unificado incluye:

**Frontends:**

- **Ensurance Frontend**: Vue 3 + TypeScript + Vite
- **Pharmacy Frontend**: Vue 3 + Vue CLI

**Backends:**

- **Ensurance Backend (BackV4)**: Java + HttpServer
- **Pharmacy Backend (BackV5)**: Java + HttpServer

**Bases de Datos:**

- **SQLite** para ambos sistemas (migrado desde Oracle)
- Ubicaci√≥n: `/app/databases/`

### üåç Configuraci√≥n Multi-Ambiente

| Ambiente | Puertos                | Rama Git                                          | Uso              |
| -------- | ---------------------- | ------------------------------------------------- | ---------------- |
| **DEV**  | 3000-3003              | `develop`, `dev`, `development`, feature branches | Desarrollo local |
| **MAIN** | 5175, 8089, 8081, 8082 | `main`, `master`                                  | Producci√≥n       |
| **QA**   | 4000-4003              | `qa`, `test`, `testing`, `staging`                | Testing/QA       |

#### Mapeo de Puertos por Ambiente

**üîß DEV (Desarrollo)**

- **Ensurance Frontend**: `3000`
- **Pharmacy Frontend**: `3001`
- **Ensurance Backend**: `3002`
- **Pharmacy Backend**: `3003`

**üöÄ MAIN (Producci√≥n)**

- **Ensurance Frontend**: `5175`
- **Pharmacy Frontend**: `8089`
- **Ensurance Backend**: `8081`
- **Pharmacy Backend**: `8082`

**üß™ QA (Testing)**

- **Ensurance Frontend**: `4000`
- **Pharmacy Frontend**: `4001`
- **Ensurance Backend**: `4002`
- **Pharmacy Backend**: `4003`

### üöÄ Uso del Script de Despliegue

#### Despliegue Autom√°tico (Recomendado)

```bash
# Detecta autom√°ticamente la rama git y despliega
./deploy.sh auto

# Con reconstrucci√≥n forzada
./deploy.sh auto --rebuild
```

#### Despliegue Manual

```bash
# Desplegar ambiente espec√≠fico
./deploy.sh deploy dev
./deploy.sh deploy main
./deploy.sh deploy qa

# Con reconstrucci√≥n forzada
./deploy.sh deploy dev --rebuild
```

#### Gesti√≥n de Ambientes

```bash
# Detener ambiente
./deploy.sh stop dev

# Ver logs en tiempo real
./deploy.sh logs main

# Ver estado de todos los contenedores
./deploy.sh status

# Limpiar todos los contenedores e im√°genes
./deploy.sh clean
```

### üîß Caracter√≠sticas del Sistema

**‚úÖ Detecci√≥n Autom√°tica de Puertos**

- El script verifica autom√°ticamente si los puertos est√°n en uso
- Mata procesos que ocupen los puertos necesarios
- Garantiza despliegue limpio sin conflictos

**üîÑ Gesti√≥n de Procesos**

```bash
# El script autom√°ticamente:
# 1. Detecta procesos usando puertos objetivo
# 2. Mata procesos conflictivos
# 3. Verifica que los puertos est√©n libres
# 4. Despliega el ambiente correspondiente
```

**üìÅ Estructura de Directorios por Ambiente**

```
./databases/
‚îú‚îÄ‚îÄ dev/
‚îÇ   ‚îú‚îÄ‚îÄ ensurance/USUARIO.sqlite
‚îÇ   ‚îî‚îÄ‚îÄ pharmacy/USUARIO.sqlite
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îú‚îÄ‚îÄ ensurance/USUARIO.sqlite
‚îÇ   ‚îî‚îÄ‚îÄ pharmacy/USUARIO.sqlite
‚îî‚îÄ‚îÄ qa/
    ‚îú‚îÄ‚îÄ ensurance/USUARIO.sqlite
    ‚îî‚îÄ‚îÄ pharmacy/USUARIO.sqlite

./logs/
‚îú‚îÄ‚îÄ dev/
‚îú‚îÄ‚îÄ main/
‚îî‚îÄ‚îÄ qa/
```

### üéØ Configuraci√≥n por Ambiente

**DEV (Desarrollo)**

- **Node.js**: `development`
- **Java**: Debug habilitado, menor memoria
- **Vol√∫menes**: C√≥digo fuente montado para hot-reload
- **Logs**: Verbose para debugging

**MAIN (Producci√≥n)**

- **Node.js**: `production`
- **Java**: Optimizado para producci√≥n
- **Vol√∫menes**: Solo datos persistentes
- **Logs**: Nivel INFO

**QA (Testing)**

- **Node.js**: `test`
- **Java**: Configuraci√≥n de testing
- **Vol√∫menes**: Datos de prueba
- **Logs**: Nivel DEBUG para testing

### üîç Monitoreo y Debugging

#### Ver Estado del Sistema

```bash
# Estado de contenedores
./deploy.sh status

# Logs espec√≠ficos por ambiente
./deploy.sh logs dev
./deploy.sh logs main
./deploy.sh logs qa
```

#### Verificar Puertos

```bash
# Ver qu√© procesos usan puertos espec√≠ficos
lsof -i :3000  # DEV frontend ensurance
lsof -i :4000  # QA frontend ensurance
lsof -i :5175  # MAIN frontend ensurance
```

#### Acceso a Contenedores

```bash
# Entrar al contenedor
docker exec -it ensurance-pharmacy-dev sh
docker exec -it ensurance-pharmacy-main sh
docker exec -it ensurance-pharmacy-qa sh
```

### üö® Troubleshooting Docker

#### Problema: Puerto Ocupado

El script autom√°ticamente mata procesos, pero si persiste:

```bash
# Verificar manualmente
lsof -ti:3000 | xargs kill -9
```

#### Problema: Contenedor No Inicia

```bash
# Ver logs detallados
docker logs ensurance-pharmacy-dev

# Reconstruir desde cero
./deploy.sh deploy dev --rebuild
```

#### Problema: Base de Datos

```bash
# Recrear bases de datos
rm -rf databases/dev
./deploy.sh deploy dev
```

### üìù Flujo de Trabajo Recomendado

1. **Desarrollo**: Trabaja en rama `develop` o feature branch

   ```bash
   git checkout develop
   ./deploy.sh auto  # Despliega en puertos 3000-3003
   ```

2. **Testing**: Merge a rama `qa`

   ```bash
   git checkout qa
   ./deploy.sh auto  # Despliega en puertos 4000-4003
   ```

3. **Producci√≥n**: Merge a rama `main`
   ```bash
   git checkout main
   ./deploy.sh auto  # Despliega en puertos 5175, 8089, 8081, 8082
   ```

---

## üìä Base de Datos

### Configuraci√≥n SQLite Unificada

El sistema usa SQLite para todos los ambientes, con bases de datos separadas por contenedor:

#### Estructura por Ambiente

```
./databases/
‚îú‚îÄ‚îÄ dev/
‚îÇ   ‚îú‚îÄ‚îÄ ensurance/USUARIO.sqlite
‚îÇ   ‚îî‚îÄ‚îÄ pharmacy/USUARIO.sqlite
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îú‚îÄ‚îÄ ensurance/USUARIO.sqlite
‚îÇ   ‚îî‚îÄ‚îÄ pharmacy/USUARIO.sqlite
‚îî‚îÄ‚îÄ qa/
    ‚îú‚îÄ‚îÄ ensurance/USUARIO.sqlite
    ‚îî‚îÄ‚îÄ pharmacy/USUARIO.sqlite
```

#### BackV4 (Ensurance Backend)

- **SQLite**: Configuraci√≥n principal
- **Migraci√≥n**: Scripts en `backv4/sqlite/`
- **Dialecto**: `org.hibernate.community.dialect.SQLiteDialect`

#### BackV5 (Pharmacy Backend)

- **SQLite**: Configuraci√≥n principal migrada de Oracle
- **Migraci√≥n**: Scripts en `backv5/sqlite/`
- **Dialecto**: `org.hibernate.community.dialect.SQLiteDialect`

### Scripts de Migraci√≥n

#### BackV4 (Ensurance Backend)

```bash
cd backv4/sqlite/

# Aplicar esquema inicial
sqlite3 USUARIO.sqlite < 01_initial_schema.sql

# Aplicar migraciones adicionales
sqlite3 USUARIO.sqlite < 02_add_missing_tables.sql
```

**Scripts disponibles:**

- `01_initial_schema.sql` - Esquema completo inicial con todas las tablas
- `02_add_missing_tables.sql` - Agrega tabla SUBCATEGORY y actualiza SYSTEM_CONFIG

#### BackV5 (Pharmacy Backend)

```bash
cd backv5/sqlite/

# Aplicar esquema inicial
sqlite3 USUARIO.sqlite < 01_initial_schema.sql

# Aplicar migraciones adicionales
sqlite3 USUARIO.sqlite < 02_add_missing_columns.sql
```

**Scripts disponibles:**

- `01_initial_schema.sql` - Esquema completo inicial del sistema de farmacia
- `02_add_missing_columns.sql` - Agrega columnas ID_CATEGORY, ID_SUBCATEGORY a MEDICINE

### Estructura de Base de Datos

#### BackV4 (Ensurance) - Tablas Principales

- **USERS** - Gesti√≥n de usuarios y autenticaci√≥n
- **POLICY** - P√≥lizas de seguros m√©dicos
- **HOSPITALS** - Informaci√≥n de hospitales
- **MEDICINE** - Cat√°logo de medicinas
- **PRESCRIPTION** - Recetas m√©dicas
- **TRANSACTIONS** - Transacciones financieras
- **APPOINTMENTS** - Citas m√©dicas
- **SYSTEM_CONFIG** - Par√°metros de configuraci√≥n del sistema
- **SUBCATEGORY** - Subcategor√≠as de medicinas

#### BackV5 (Pharmacy) - Tablas Principales

- **USERS** - Gesti√≥n de usuarios y autenticaci√≥n
- **MEDICINE** - Cat√°logo de medicinas con categor√≠as jer√°rquicas
- **PRESCRIPTION** - Recetas m√©dicas con detalles de medicinas
- **ORDERS** - √ìrdenes de clientes
- **BILL** - Informaci√≥n de facturaci√≥n con cobertura de seguros
- **COMMENTS** - Comentarios de usuarios sobre medicinas
- **SERVICE_APPROVALS** - Flujo de trabajo de aprobaci√≥n de servicios
- **SYSTEM_CONFIG** - Par√°metros de configuraci√≥n del sistema
- **CATEGORY** - Categor√≠as de medicinas
- **SUBCATEGORY** - Subcategor√≠as de medicinas

### Caracter√≠sticas Clave

**BackV4 (Ensurance):**

- Sistema de seguros m√©dicos completo
- Gesti√≥n de p√≥lizas y transacciones
- Integraci√≥n con hospitales
- Sistema de citas m√©dicas

**BackV5 (Pharmacy):**

- Categorizaci√≥n jer√°rquica de medicinas
- Gesti√≥n detallada de recetas con dosificaci√≥n, frecuencia, duraci√≥n
- Flujo completo de √≥rdenes desde creaci√≥n hasta facturaci√≥n
- Integraci√≥n con seguros y c√°lculos de cobertura
- Sistema de comentarios comunitarios

### Verificaci√≥n de Datos

```bash
# Verificar en contenedores Docker
docker exec -it ensurance-pharmacy-dev sqlite3 /app/databases/ensurance/USUARIO.sqlite ".tables"
docker exec -it ensurance-pharmacy-main sqlite3 /app/databases/pharmacy/USUARIO.sqlite "SELECT COUNT(*) FROM MEDICINE;"

# Verificar localmente
sqlite3 databases/dev/ensurance/USUARIO.sqlite "SELECT COUNT(*) FROM USERS;"
sqlite3 databases/main/pharmacy/USUARIO.sqlite ".schema MEDICINE"

# Verificar estructura de tablas
sqlite3 backv4/sqlite/USUARIO.sqlite ".schema POLICY"
sqlite3 backv5/sqlite/USUARIO.sqlite ".schema PRESCRIPTION"
```

### Notas T√©cnicas

- Todos los scripts usan `CREATE TABLE IF NOT EXISTS` para prevenir errores en re-ejecuciones
- BackV5 tiene `PRAGMA foreign_keys = ON` habilitado
  -#### ‚ö†Ô∏è Consideraciones de Seguridad

- Configurar autenticaci√≥n robusta en todos los servicios antes de exponerlos
- Usar tokens de acceso espec√≠ficos para integraciones externas
- Revisar logs de acceso regularmente
- Considerar usar Tailscale ACLs para restringir acceso por usuario/grupo

### üîê Configuraci√≥n de Secretos y CI/CD

## üìã Secretos Requeridos para CI/CD

### üêô GitHub Actions Secrets

**‚ö†Ô∏è CONFIGURACI√ìN OBLIGATORIA - Secretos que DEBES agregar en GitHub:**

Ir a `Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions` y agregar:

#### üîß SonarQube (OBLIGATORIO)

```bash
SONAR_TOKEN                    # Token de SonarQube para an√°lisis de c√≥digo
SONAR_HOST_URL                 # URL del servidor SonarQube
```

#### üè• Ensurance Project Tokens (YA CONFIGURADOS)

```bash
ENSURANCE_BACK_DEV             # Token SonarQube ensurance-backend-dev
ENSURANCE_BACK_QA              # Token SonarQube ensurance-backend-qa
ENSURANCE_BACK_MAIN            # Token SonarQube ensurance-backend-main
ENSURANCE_FRONT_DEV            # Token SonarQube ensurance-frontend-dev
ENSURANCE_FRONT_QA             # Token SonarQube ensurance-frontend-qa
ENSURANCE_FRONT_MAIN           # Token SonarQube ensurance-frontend-main
```

#### üíä Pharmacy Project Tokens (‚ö†Ô∏è FALTANTES - AGREGAR URGENTE)

```bash
PHARMACY_BACK_DEV              # Token SonarQube pharmacy-backend-dev
PHARMACY_BACK_QA               # Token SonarQube pharmacy-backend-qa
PHARMACY_BACK_MAIN             # Token SonarQube pharmacy-backend-main
PHARMACY_FRONT_DEV             # Token SonarQube pharmacy-frontend-dev
PHARMACY_FRONT_QA              # Token SonarQube pharmacy-frontend-qa
PHARMACY_FRONT_MAIN            # Token SonarQube pharmacy-frontend-main
```

#### üìß Notificaciones Email (OBLIGATORIO)

```bash
SMTP_SERVER                    # Servidor SMTP (ej: smtp.gmail.com)
SMTP_PORT                      # Puerto SMTP (ej: 587 para TLS, 465 para SSL)
SMTP_USERNAME                  # Usuario SMTP para autenticaci√≥n
SMTP_PASSWORD                  # Password/App Password SMTP
SMTP_FROM_EMAIL                # Email remitente (ej: noreply@company.com)
NOTIFICATION_EMAIL             # Email(s) destinatario(s) separados por coma
```

### üöÅ Drone CI Secrets

Para configurar en Drone UI (http://localhost:8000):

#### Ir a Repository Settings ‚Üí Secrets y agregar:

```bash
# SonarQube Analysis
ensurance_back_dev             # Token para ensurance-backend-dev
ensurance_back_qa              # Token para ensurance-backend-qa
ensurance_back_main            # Token para ensurance-backend-main
pharmacy_back_dev              # Token para pharmacy-backend-dev (‚ö†Ô∏è FALTANTE)
pharmacy_back_qa               # Token para pharmacy-backend-qa (‚ö†Ô∏è FALTANTE)
pharmacy_back_main             # Token para pharmacy-backend-main (‚ö†Ô∏è FALTANTE)

# Email Notifications
email_username                 # Usuario SMTP para notificaciones
email_password                 # Password SMTP para notificaciones

# SonarQube Server
sonar_host_url                 # URL del servidor SonarQube
```

### üîß Jenkins Credentials

Configurar en Jenkins UI (http://localhost:8080/jenkins):

#### Ir a Manage Jenkins ‚Üí Credentials ‚Üí Global y agregar:

```bash
# SonarQube Server
sonarqube-token               # Token global de SonarQube

# Project Specific Tokens (si se requieren)
ensurance-sonar-token         # Token espec√≠fico para Ensurance
pharmacy-sonar-token          # Token espec√≠fico para Pharmacy (‚ö†Ô∏è FALTANTE)
```

## üèóÔ∏è Proyectos SonarQube Requeridos

### ‚ö†Ô∏è CREAR ESTOS PROYECTOS EN SONARQUBE:

#### üè• Ensurance Projects (YA CREADOS)

```bash
ensurance-backend-dev          # Backend Ensurance ambiente DEV
ensurance-backend-qa           # Backend Ensurance ambiente QA
ensurance-backend-main         # Backend Ensurance ambiente MAIN
ensurance-frontend-dev         # Frontend Ensurance ambiente DEV
ensurance-frontend-qa          # Frontend Ensurance ambiente QA
ensurance-frontend-main        # Frontend Ensurance ambiente MAIN
```

#### üíä Pharmacy Projects (‚ö†Ô∏è CREAR URGENTE)

```bash
pharmacy-backend-dev           # Backend Pharmacy ambiente DEV
pharmacy-backend-qa            # Backend Pharmacy ambiente QA
pharmacy-backend-main          # Backend Pharmacy ambiente MAIN
pharmacy-frontend-dev          # Frontend Pharmacy ambiente DEV
pharmacy-frontend-qa           # Frontend Pharmacy ambiente QA
pharmacy-frontend-main         # Frontend Pharmacy ambiente MAIN
```

## üìù Pasos de Configuraci√≥n

### 1Ô∏è‚É£ Crear Proyectos SonarQube

```bash
# Acceder a SonarQube
http://localhost:9000/sonar
# o tu URL de Tailscale: https://tu-nodo.ts.net/sonar

# Para cada proyecto:
1. Administration ‚Üí Projects ‚Üí Create Project
2. Usar el nombre exacto del proyecto (ej: pharmacy-backend-dev)
3. Generar token para el proyecto
4. Copiar el token generado
```

### 2Ô∏è‚É£ Configurar Secretos GitHub

```bash
# Ir a tu repositorio en GitHub
1. Settings ‚Üí Secrets and variables ‚Üí Actions
2. New repository secret
3. Agregar cada secreto con su token correspondiente
4. Verificar que el nombre coincida exactamente
```

### 3Ô∏è‚É£ Configurar Secretos Drone

```bash
# Acceder a Drone UI
http://localhost:8000

# Para cada repositorio:
1. Repository Settings ‚Üí Secrets
2. Agregar cada secreto
3. Marcar "Pull Request" si se necesita en PRs
4. Verificar que el nombre est√© en min√∫sculas
```

### 4Ô∏è‚É£ Verificar Configuraci√≥n

```bash
# Hacer un commit y push para probar
git add .
git commit -m "test: verificar configuraci√≥n CI/CD"
git push origin tu-rama

# Verificar que los workflows ejecuten correctamente:
# - GitHub Actions: pesta√±a Actions en GitHub
# - Drone CI: http://localhost:8000
# - Jenkins: http://localhost:8080/jenkins
```

## üìä Valores de Ejemplo

### SonarQube

```bash
SONAR_TOKEN=squ_1234567890abcdef...
SONAR_HOST_URL=https://macbook-air-de-gp.tail5d54f7.ts.net/sonar
```

### Email SMTP (Gmail)

```bash
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password  # Usar App Password, no contrase√±a normal
SMTP_FROM_EMAIL=noreply@ensurancepharmacy.com
NOTIFICATION_EMAIL=pablopolis2016@gmail.com,jflores@unis.edu.gt
```

### Otros Proveedores SMTP

```bash
# Outlook/Hotmail
SMTP_SERVER=smtp-mail.outlook.com
SMTP_PORT=587

# Yahoo
SMTP_SERVER=smtp.mail.yahoo.com
SMTP_PORT=587

# SendGrid
SMTP_SERVER=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USERNAME=apikey
SMTP_PASSWORD=your-sendgrid-api-key
```

## ‚ö†Ô∏è Notas Importantes

### Seguridad

- **NUNCA** hardcodear tokens en el c√≥digo
- Usar App Passwords para Gmail (no contrase√±a normal)
- Rotar tokens peri√≥dicamente
- Verificar permisos m√≠nimos necesarios

### Troubleshooting

- Verificar nombres exactos de secretos (case-sensitive)
- Confirmar que proyectos SonarQube existan
- Verificar conectividad de red a SonarQube
- Revisar logs de workflows para errores espec√≠ficos

### Flujo de An√°lisis

```bash
# Cada Push/PR ejecutar√°:
1. Tests unitarios (Backend + Frontend)
2. Generaci√≥n de coverage (JaCoCo + LCOV)
3. An√°lisis SonarQube separado por proyecto
4. Quality Gate por proyecto independiente
5. Notificaci√≥n email con resultados
```

### üìß Configuraci√≥n SMTP para Notificaciones por Email

Los workflows de GitHub Actions env√≠an notificaciones autom√°ticas por email despu√©s de ejecutar tests y an√°lisis SonarQube.

#### üîß Configuraci√≥n Requerida

**1. Configurar Secretos en GitHub:**

Ir a `Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions` y agregar:

```bash
SMTP_SERVER=smtp.gmail.com              # Servidor SMTP
SMTP_PORT=587                           # Puerto (587 para TLS, 465 para SSL)
SMTP_USERNAME=your-email@gmail.com      # Usuario SMTP
SMTP_PASSWORD=your-app-password         # App Password de Gmail
SMTP_FROM_EMAIL=noreply@company.com     # Email remitente
NOTIFICATION_EMAIL=team@company.com     # Destinatarios (separados por coma)
```

#### üì® Proveedores SMTP Comunes

**Gmail:**

```bash
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
# Requiere App Password: https://support.google.com/accounts/answer/185833
```

**Outlook/Hotmail:**

```bash
SMTP_SERVER=smtp-mail.outlook.com
SMTP_PORT=587
```

**Yahoo:**

```bash
SMTP_SERVER=smtp.mail.yahoo.com
SMTP_PORT=587
```

**SendGrid:**

```bash
SMTP_SERVER=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USERNAME=apikey
SMTP_PASSWORD=your-sendgrid-api-key
```

#### üì¨ Tipos de Notificaciones

**1. CI/CD Pipeline (ci-cd.yml):**

- Se env√≠a despu√©s de todos los tests y an√°lisis SonarQube
- Incluye estado de cada job (‚úÖ/‚ùå)
- Detecta autom√°ticamente el ambiente (DEV/QA/MAIN)
- Enlace directo al workflow run

**2. Pull Request Analysis (sonarqube-pr-analysis.yml):**

- Se env√≠a despu√©s del an√°lisis SonarQube en PRs
- Incluye estado del Quality Gate
- Enlaces al PR y al an√°lisis
- Detecta ambiente objetivo del PR

#### üé® Formato de Emails

Los emails incluyen:

- **Estado visual** con colores (verde/rojo)
- **Informaci√≥n del commit** (autor, rama, hash)
- **Resultados detallados** de cada job
- **Enlaces directos** a GitHub y workflows
- **Dise√±o responsive** HTML

#### üîç Troubleshooting SMTP

**Error de autenticaci√≥n:**

- Verificar que SMTP_USERNAME y SMTP_PASSWORD sean correctos
- Para Gmail, usar App Password en lugar de contrase√±a normal
- Verificar que 2FA est√© habilitado en Gmail

**Error de conexi√≥n:**

- Verificar SMTP_SERVER y SMTP_PORT
- Algunos proveedores requieren TLS (puerto 587) vs SSL (puerto 465)

**Emails no llegan:**

- Verificar carpeta de spam/junk
- Confirmar que NOTIFICATION_EMAIL est√© bien formateado
- Verificar l√≠mites de rate del proveedor SMTP

---

## üîó Integraciones

### Exponer CI/CD con Tailscale Funnel

Para exponer de forma segura los servicios de CI/CD (Jenkins, SonarQube y Drone) a trav√©s de tu tailnet, usa Tailscale Funnel. Requisitos: haber iniciado sesi√≥n con `tailscale up` y tener Funnel habilitado en tu tailnet.

Comandos para levantar los t√∫neles:

```bash
# Jenkins en /jenkins ‚Üí http://127.0.0.1:8080/jenkins
tailscale funnel --https=443 --set-path=/jenkins --bg http://127.0.0.1:8080/jenkins

# SonarQube en /sonar ‚Üí http://127.0.0.1:9000/sonar
tailscale funnel --https=443 --set-path=/sonar --bg http://127.0.0.1:9000/sonar

# Drone en / ‚Üí http://127.0.0.1:8000 Nota: Drone no tiene path, porque no lo soporta
tailscale funnel --https=443 --set-path=/ --bg http://127.0.0.1:8000
```

Notas:

- Aseg√∫rate de que los servicios est√©n corriendo localmente (ver `docker-compose.cicd.yml`).
- La URL p√∫blica tendr√° el formato `https://<tu-nodo>.ts.net/<path>`.
- Para ver estado o detener: `tailscale funnel status` y `tailscale funnel stop`.

### APIs Externas

- **Hospital API**: `http://localhost:8000/api`
- **Servicios espec√≠ficos**: `http://localhost:5050/api`

### Comunicaci√≥n Entre Servicios

- **Ensurance ‚Üî Pharmacy**: Comunicaci√≥n bidireccional para verificaci√≥n de recetas y pol√≠ticas
- **Frontend ‚Üî Backend**: APIs REST con autenticaci√≥n JWT
- **Backend ‚Üî Hospital**: Integraci√≥n para citas m√©dicas

### Funciones de API Configurables

#### Frontend Ensurance

```javascript
import { getInsuranceApiUrl, getPharmacyApiUrl } from "~/utils/api";
const response = await axios.get(getInsuranceApiUrl("hospital"));
```

#### Frontend Pharmacy

```javascript
import ApiService from "@/services/ApiService";
const response = await axios.get(ApiService.getPharmacyApiUrl("/medicines"));
```

---

## üìö Documentaci√≥n por Componente

### üõ°Ô∏è Ensurance Frontend (Vue 3 + TypeScript + Vite)

**Caracter√≠sticas:**

- Vue 3 con `<script setup>` y Composition API
- TypeScript para type safety
- Vite para desarrollo r√°pido
- Tailwind CSS para estilos
- Pinia para gesti√≥n de estado
- Vitest para testing unitario

**Comandos principales:**

```bash
npm run dev      # Desarrollo con hot-reload
npm run build    # Build de producci√≥n
npm run preview  # Preview del build
npm run test     # Tests unitarios
```

**Estructura:**

- `src/components/` - Componentes reutilizables
- `src/pages/` - P√°ginas de la aplicaci√≥n
- `src/utils/` - Utilidades y helpers
- `tests/` - Tests unitarios

### üíä Pharmacy Frontend (Vue 3 + Vue CLI)

**Caracter√≠sticas:**

- Vue 3 con Options API
- Vue CLI para tooling
- Jest para testing
- CSS personalizado
- Integraci√≥n con APIs de farmacia

**Comandos principales:**

```bash
npm run serve    # Desarrollo
npm run build    # Build de producci√≥n
npm run lint     # Linting
npm run test:unit # Tests unitarios
```

### üîß Ensurance Backend (BackV4 - Java)

**Caracter√≠sticas:**

- Java con `HttpServer` nativo
- Hibernate ORM con soporte Oracle/SQLite
- Endpoints bajo `/api`
- Perfiles Maven para diferentes entornos

**Endpoints principales:**

- `POST /api/login`
- `GET/POST/PUT /api/users`
- `GET/POST/PUT /api/policies`
- `GET/POST/PUT /api/transactions`

**Configuraci√≥n Hibernate:**

- Oracle: `hibernate.cfg.xml` (por defecto)
- SQLite: `hibernate-sqlite-{ENVIRONMENT}.cfg.xml`

### üè• Pharmacy Backend (BackV5 - Java)

**Caracter√≠sticas:**

- Java 23 con preview features
- HttpServer ligero
- Endpoints bajo `/api2`
- Migrado completamente a SQLite

**Endpoints principales:**

- `POST /api2/login`
- `GET/POST/PUT /api2/medicines`
- `GET /api2/medicines/search`
- `GET/POST/PUT /api2/orders`
- `GET/POST/PUT /api2/prescriptions`

**Variables de entorno:**

- `SERVER_HOST` (default: `0.0.0.0`)
- `SERVER_PORT` (default: `8081`)
- `ENS_BACKEND_API_URL`
- `HOSPITAL_API_URL`

---

## üéØ Acceso R√°pido por Ambiente

### üîß DEV (Desarrollo)

- üõ°Ô∏è **Seguros**: http://localhost:3000
- üíä **Farmacia**: http://localhost:3001
- üîå **API Seguros**: http://localhost:8081/api
- üîå **API Farmacia**: http://localhost:8082/api2

### üß™ QA (Testing)

- üõ°Ô∏è **Seguros**: http://localhost:4000
- üíä **Farmacia**: http://localhost:4001
- üîå **API Seguros**: http://localhost:4002/api
- üîå **API Farmacia**: http://localhost:4003/api2

### üöÄ MAIN (Producci√≥n)

- üõ°Ô∏è **Seguros**: http://localhost:5175
- üíä **Farmacia**: http://localhost:8089
- üîå **API Seguros**: http://localhost:8081/api
- üîå **API Farmacia**: http://localhost:8082/api2

---

## üë§ Credenciales de Administrador

Para facilitar el testing y acceso a todos los sistemas, se ha creado un usuario administrador en todas las bases de datos:

### üîê Credenciales de Login

| Campo        | Valor                         |
| ------------ | ----------------------------- |
| **Email**    | `admin@ensurancepharmacy.com` |
| **Password** | `admin123`                    |
| **Rol**      | `ADMIN`                       |
| **Nombre**   | `Administrator`               |
| **CUI**      | `1234567890123`               |
| **Estado**   | `Activo (ENABLED = 1)`        |

### üåê Disponibilidad por Ambiente

**‚úÖ Usuario disponible en:**

- **DEV**: Ensurance + Pharmacy (puertos 3000-3003)
- **QA**: Ensurance + Pharmacy (puertos 4000-4003)
- **MAIN**: Ensurance + Pharmacy (puertos 5175, 8089, 8081, 8082)

### üìä Bases de Datos Configuradas

**Ensurance (BackV4):**

- `databases/dev/ensurance/USUARIO.sqlite`
- `databases/qa/ensurance/USUARIO.sqlite`
- `databases/main/ensurance/USUARIO.sqlite`
- `backv4/sqlite/*.sqlite` (todas las variantes)

**Pharmacy (BackV5):**

- `databases/dev/pharmacy/USUARIO.sqlite`
- `databases/qa/pharmacy/USUARIO.sqlite`
- `databases/main/pharmacy/USUARIO.sqlite`
- `backv5/sqlite/*.sqlite` (todas las variantes)

### üîç Verificaci√≥n de Login

```bash
# Verificar usuario en cualquier base de datos
sqlite3 databases/dev/ensurance/USUARIO.sqlite "SELECT EMAIL, NAME, ROL FROM USERS WHERE EMAIL = 'admin@ensurancepharmacy.com';"

# Resultado esperado:
# admin@ensurancepharmacy.com|Administrator|ADMIN
```

**‚ö†Ô∏è Nota de Seguridad:** Estas credenciales son para desarrollo y testing. En producci√≥n real, cambiar la contrase√±a y usar autenticaci√≥n m√°s robusta.

---

## üõ†Ô∏è Troubleshooting

### Problemas Comunes

1. **Puerto en uso**: Ajustar variables de entorno `SERVER_PORT`
2. **Base de datos no disponible**: Verificar archivos SQLite en `sqlite/`
3. **APIs no responden**: Verificar que backends est√©n iniciados
4. **Tests fallan**: Ejecutar `./test-runner.sh` opci√≥n 9 para instalar dependencias

### Configuraci√≥n de Puertos

- **Frontend**: Los puertos se configuran desde la UI y se guardan en `localStorage`
- **Backend**: Se configuran via variables de entorno
- **Docker**: Se mapean seg√∫n variables `*_HOST_PORT`

### Logs y Debugging

```bash
# Ver logs de tests
mvn -f backv4 -Dsurefire.useFile=false test

# Verificar conectividad SQLite
mvn -f backv4 -Psqlite-dev -Dtest=SQLiteConnectivityTest test
```

---

## üìÑ Archivos de Configuraci√≥n Importantes

### üê≥ Docker y Despliegue

- `deploy.sh` - Script unificado de despliegue multi-ambiente
- `Dockerfile` - Contenedor unificado multi-stage
- `docker-compose.dev.yml` - Configuraci√≥n ambiente desarrollo (puertos 3000-3003)
- `docker-compose.qa.yml` - Configuraci√≥n ambiente testing (puertos 4000-4003)
- `docker-compose.main.yml` - Configuraci√≥n ambiente producci√≥n (puertos 5175, 8089, 8081, 8082)
- `.dockerignore` - Exclusiones para build de Docker

### üîß CI/CD y Calidad

- `Jenkinsfile` - Pipeline CI/CD multi-ambiente
- `sonar-project.properties` - Configuraci√≥n SonarQube con an√°lisis por rama
- `test-runner.sh` - Script unificado de testing

### üìä Base de Datos

- `backv4/sqlite/` - Scripts de migraci√≥n Ensurance
- `backv5/sqlite/` - Scripts de migraci√≥n Pharmacy

### üåê Frontend

- `ensurance/.env.example` - Variables de entorno Ensurance
- `pharmacy/.env.example` - Variables de entorno Pharmacy

---

## üîÑ CI/CD Pipeline

### üìã Jobs para Branch Protection Rules

**Nombres exactos de jobs que DEBES configurar en GitHub Branch Protection:**

#### üîß Jobs Obligatorios para Branch Protection

**CI/CD Pipeline (ci-cd.yml):**

```bash
test-backend-v4                    # Tests Backend V4 (Ensurance)
test-backend-v5                    # Tests Backend V5 (Pharmacy)
test-ensurance-frontend            # Tests Frontend Ensurance
test-pharmacy-frontend             # Tests Frontend Pharmacy
sonarqube-ensurance-analysis       # An√°lisis SonarQube Ensurance
sonarqube-pharmacy-analysis        # An√°lisis SonarQube Pharmacy
```

**Pull Request Analysis (sonarqube-pr-analysis.yml):**

```bash
sonarqube-ensurance-pr-analysis    # An√°lisis SonarQube Ensurance PR
sonarqube-pharmacy-pr-analysis     # An√°lisis SonarQube Pharmacy PR
```

**Status Check (status-check.yml):**

```bash
status-summary                     # Resumen de estado de todos los checks
```

#### ‚öôÔ∏è Configuraci√≥n en GitHub

**Ir a: Repository ‚Üí Settings ‚Üí Branches ‚Üí Add rule**

Para ramas `main`, `develop`, y `qa`:

```bash
# Require status checks to pass before merging
‚òëÔ∏è test-backend-v4
‚òëÔ∏è test-backend-v5
‚òëÔ∏è test-ensurance-frontend
‚òëÔ∏è test-pharmacy-frontend
‚òëÔ∏è sonarqube-ensurance-analysis
‚òëÔ∏è sonarqube-pharmacy-analysis
‚òëÔ∏è sonarqube-ensurance-pr-analysis
‚òëÔ∏è sonarqube-pharmacy-pr-analysis
‚òëÔ∏è status-summary
```

#### üö´ Jobs NO Obligatorios (Se ejecutan autom√°ticamente)

```bash
deploy-dev          # Deploy autom√°tico a DEV (solo push a develop)
deploy-qa           # Deploy autom√°tico a QA (solo push a qa)
deploy-main         # Deploy autom√°tico a MAIN (solo push a main)
notify-status       # Notificaci√≥n email despu√©s del CI/CD
notify-pr-status    # Notificaci√≥n email despu√©s del PR analysis
```

### Flujo Autom√°tico por Rama

**Ramas DEV** (`dev`, `develop`, `development`):

- ‚úÖ Tests unitarios y cobertura
- üîç An√°lisis SonarQube
- üöÄ Deploy autom√°tico en puertos 3000-3003

**Ramas QA** (`qa`, `test`, `testing`, `staging`):

- ‚úÖ Tests unitarios y cobertura
- üîç An√°lisis SonarQube
- üöÄ Deploy autom√°tico en puertos 4000-4003

**Ramas MAIN** (`main`, `master`):

- ‚úÖ Tests unitarios y cobertura
- üîç An√°lisis SonarQube
- üöÄ Deploy autom√°tico en puertos 5175, 8089, 8081, 8082

### SonarQube

```bash
# An√°lisis local
./test-runner.sh
# Seleccionar opci√≥n 10: Run SonarQube analysis

# El pipeline ejecuta autom√°ticamente:
# - Cobertura de backends (JaCoCo)
# - Cobertura de frontends (LCOV)
# - An√°lisis por rama
# - Quality Gate
```

---

_√öltima actualizaci√≥n: Agosto 2025_

**Desarrollado por el equipo de Ensurance Pharmacy**

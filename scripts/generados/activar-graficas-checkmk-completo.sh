#!/bin/bash

# ============================================================================
# SCRIPT MAESTRO: ACTIVAR GR√ÅFICAS EN CHECKMK
# Ejecuta todo el proceso de configuraci√≥n de una vez
# ============================================================================

set -e

BOLD='\033[1m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BOLD}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                                    ‚ïë"
echo "‚ïë     ACTIVAR GR√ÅFICAS EN CHECKMK - SIMILAR A NETDATA              ‚ïë"
echo "‚ïë                                                                    ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"

# ============================================================================
# VERIFICAR REQUISITOS
# ============================================================================
echo -e "${BLUE}[1/6] Verificando requisitos...${NC}"

# Verificar que CheckMK est√© corriendo
if ! docker ps | grep -q ensurance-checkmk-full; then
    echo -e "${RED}‚ùå CheckMK no est√° corriendo${NC}"
    echo ""
    echo "Inicia los contenedores primero:"
    echo "  ./start-docker-full.sh"
    exit 1
fi

echo -e "${GREEN}  ‚úÖ CheckMK est√° corriendo${NC}"

# Verificar que Prometheus est√© corriendo
if ! docker ps | grep -q ensurance-prometheus-full; then
    echo -e "${RED}‚ùå Prometheus no est√° corriendo${NC}"
    exit 1
fi

echo -e "${GREEN}  ‚úÖ Prometheus est√° corriendo${NC}"

# Verificar que Node Exporter est√© corriendo
if ! docker ps | grep -q ensurance-node-exporter-full; then
    echo -e "${RED}‚ùå Node Exporter no est√° corriendo${NC}"
    exit 1
fi

echo -e "${GREEN}  ‚úÖ Node Exporter est√° corriendo${NC}"

# ============================================================================
# PASO 1: CONFIGURAR DASHBOARDS
# ============================================================================
echo ""
echo -e "${BLUE}[2/6] Configurando dashboards...${NC}"

if [ -f "./configurar-dashboards-checkmk.sh" ]; then
    ./configurar-dashboards-checkmk.sh > /tmp/checkmk-dashboard-config.log 2>&1
    echo -e "${GREEN}  ‚úÖ Dashboards configurados${NC}"
else
    echo -e "${YELLOW}  ‚ö†Ô∏è  Script de dashboards no encontrado, saltando...${NC}"
fi

# ============================================================================
# PASO 2: CONFIGURAR PLUGINS DE GR√ÅFICAS
# ============================================================================
echo ""
echo -e "${BLUE}[3/6] Configurando plugins de gr√°ficas...${NC}"

if [ -f "./configurar-graficas-prometheus-checkmk.sh" ]; then
    ./configurar-graficas-prometheus-checkmk.sh > /tmp/checkmk-graph-config.log 2>&1
    echo -e "${GREEN}  ‚úÖ Plugins de gr√°ficas configurados${NC}"
else
    echo -e "${YELLOW}  ‚ö†Ô∏è  Script de gr√°ficas no encontrado, saltando...${NC}"
fi

# ============================================================================
# PASO 3: HABILITAR SERVICIOS
# ============================================================================
echo ""
echo -e "${BLUE}[4/6] Habilitando servicios y m√©tricas...${NC}"

if [ -f "./habilitar-graficas-checkmk.sh" ]; then
    ./habilitar-graficas-checkmk.sh > /tmp/checkmk-enable.log 2>&1
    echo -e "${GREEN}  ‚úÖ Servicios habilitados${NC}"
else
    echo -e "${YELLOW}  ‚ö†Ô∏è  Script de habilitaci√≥n no encontrado, saltando...${NC}"
fi

# ============================================================================
# PASO 4: VERIFICAR CONFIGURACI√ìN
# ============================================================================
echo ""
echo -e "${BLUE}[5/6] Verificando configuraci√≥n...${NC}"

# Verificar que CheckMK responda
if curl -s -u "cmkadmin:admin123" "http://localhost:5152/ensurance/check_mk/api/1.0/domain-types/host_config/collections/all" > /dev/null 2>&1; then
    echo -e "${GREEN}  ‚úÖ API de CheckMK funciona correctamente${NC}"
else
    echo -e "${YELLOW}  ‚ö†Ô∏è  No se pudo conectar a la API de CheckMK${NC}"
fi

# Contar hosts
host_count=$(docker exec ensurance-checkmk-full omd su ensurance -c "cmk --list-hosts 2>/dev/null | wc -l" 2>/dev/null || echo "0")
echo -e "${GREEN}  ‚úÖ Hosts configurados: $host_count${NC}"

# Contar servicios
service_count=$(curl -s -u "cmkadmin:admin123" "http://localhost:5152/ensurance/check_mk/api/1.0/domain-types/service/collections/all" 2>/dev/null | grep -o '"service_description"' | wc -l || echo "0")
echo -e "${GREEN}  ‚úÖ Servicios activos: $service_count${NC}"

# ============================================================================
# PASO 5: CREAR P√ÅGINA DE RESUMEN
# ============================================================================
echo ""
echo -e "${BLUE}[6/6] Creando p√°gina de resumen...${NC}"

cat > /tmp/checkmk-graficas-resumen.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gr√°ficas Configuradas - Ensurance Pharmacy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .success-message {
            background: #00b894;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.2em;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .card p { color: #666; margin-bottom: 15px; line-height: 1.6; }
        .card a {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .card a:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: scale(1.05);
        }
        .icon { font-size: 3em; margin-bottom: 15px; }
        .info-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 20px;
        }
        .info-box h3 { color: #667eea; margin-bottom: 15px; }
        .info-box ul { list-style: none; padding-left: 0; }
        .info-box li {
            color: #666;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .info-box li:last-child { border-bottom: none; }
        .warning-box {
            background: #fdcb6e;
            color: #2d3436;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .warning-box h3 { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ Gr√°ficas Configuradas Exitosamente</h1>
            <p>CheckMK, Grafana y Netdata est√°n listos para usar</p>
        </div>
        
        <div class="success-message">
            üéâ ¬°Todo configurado! Las gr√°ficas estar√°n disponibles en 15-30 minutos
        </div>
        
        <div class="warning-box">
            <h3>‚è±Ô∏è Importante: Tiempo de Espera</h3>
            <p><strong>CheckMK necesita recolectar datos hist√≥ricos antes de mostrar gr√°ficas:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>‚Ä¢ Primera verificaci√≥n: 1-5 minutos</li>
                <li>‚Ä¢ Primeras m√©tricas: 5-10 minutos</li>
                <li>‚Ä¢ Gr√°ficas completas: <strong>15-30 minutos</strong></li>
            </ul>
            <p style="margin-top: 15px;"><strong>üí° Mientras esperas:</strong> Usa Grafana o Netdata para ver gr√°ficas inmediatas</p>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="icon">üìà</div>
                <h2>Grafana</h2>
                <p><strong>‚≠ê RECOMENDADO PARA GR√ÅFICAS</strong></p>
                <p>Dashboards completos con gr√°ficas hermosas, id√©nticas a Netdata</p>
                <p><strong>Usuario:</strong> admin<br><strong>Password:</strong> admin123</p>
                <a href="http://localhost:3001" target="_blank">Abrir Grafana ‚Üí</a>
            </div>
            
            <div class="card">
                <div class="icon">‚ö°</div>
                <h2>Netdata</h2>
                <p><strong>TIEMPO REAL</strong></p>
                <p>Gr√°ficas actualizadas cada segundo. Ideal para troubleshooting</p>
                <a href="http://localhost:19999" target="_blank">Abrir Netdata ‚Üí</a>
            </div>
            
            <div class="card">
                <div class="icon">üìä</div>
                <h2>CheckMK</h2>
                <p><strong>GESTI√ìN Y ALERTAS</strong></p>
                <p>Dashboards configurados, alertas enterprise, gesti√≥n de servicios</p>
                <p><strong>Usuario:</strong> cmkadmin<br><strong>Password:</strong> admin123</p>
                <a href="http://localhost:5152/ensurance/check_mk/" target="_blank">Abrir CheckMK ‚Üí</a>
            </div>
        </div>
        
        <div class="info-box">
            <h3>üìä Dashboards Creados en CheckMK</h3>
            <ul>
                <li><strong>Dashboard Principal:</strong> Overview con estado de hosts, servicios y gr√°ficas de sistema</li>
                <li><strong>System Metrics:</strong> CPU, Memoria, Disco y Red de todos los hosts</li>
                <li><strong>Applications:</strong> Estado de aplicaciones, Prometheus, RabbitMQ, Netdata</li>
            </ul>
        </div>
        
        <div class="info-box">
            <h3>üéØ C√≥mo Ver Gr√°ficas en CheckMK</h3>
            <ul>
                <li><strong>Opci√≥n 1:</strong> Monitor ‚Üí Dashboards ‚Üí Selecciona un dashboard</li>
                <li><strong>Opci√≥n 2:</strong> Monitor ‚Üí All services ‚Üí Click en servicio ‚Üí Ver "Service Metrics"</li>
                <li><strong>Opci√≥n 3:</strong> Monitor ‚Üí Performance ‚Üí Selecciona host ‚Üí Ver todas las gr√°ficas</li>
            </ul>
        </div>
        
        <div class="info-box">
            <h3>üí° Recomendaciones</h3>
            <ul>
                <li><strong>Para gr√°ficas hermosas:</strong> Usa Grafana (mejor visualizaci√≥n)</li>
                <li><strong>Para tiempo real:</strong> Usa Netdata (actualizaci√≥n cada segundo)</li>
                <li><strong>Para alertas:</strong> Usa CheckMK (sistema enterprise)</li>
                <li><strong>Para an√°lisis:</strong> Usa Prometheus (consultas PromQL)</li>
            </ul>
        </div>
    </div>
</body>
</html>
HTMLEOF

# Copiar al directorio de CheckMK
docker cp /tmp/checkmk-graficas-resumen.html ensurance-checkmk-full:/omd/sites/ensurance/var/check_mk/web/htdocs/graficas-configuradas.html 2>/dev/null || true

echo -e "${GREEN}  ‚úÖ P√°gina de resumen creada${NC}"

# ============================================================================
# RESUMEN FINAL
# ============================================================================
echo ""
echo -e "${BOLD}${GREEN}"
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                                                                    ‚ïë"
echo "‚ïë              ‚úÖ CONFIGURACI√ìN COMPLETADA EXITOSAMENTE             ‚ïë"
echo "‚ïë                                                                    ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo -e "${NC}"

echo ""
echo -e "${BOLD}ACCESO A LAS HERRAMIENTAS:${NC}"
echo ""
echo -e "${BLUE}üìä CheckMK:${NC}"
echo "   URL:      http://localhost:5152/ensurance/check_mk/"
echo "   Usuario:  cmkadmin"
echo "   Password: admin123"
echo ""
echo -e "${GREEN}üìà Grafana (RECOMENDADO PARA GR√ÅFICAS):${NC}"
echo "   URL:      http://localhost:3001"
echo "   Usuario:  admin"
echo "   Password: admin123"
echo ""
echo -e "${YELLOW}‚ö° Netdata (TIEMPO REAL):${NC}"
echo "   URL:      http://localhost:19999"
echo ""
echo -e "${BLUE}üéØ P√°gina de Resumen:${NC}"
echo "   URL:      http://localhost:5152/ensurance/graficas-configuradas.html"
echo ""

echo -e "${BOLD}DASHBOARDS CREADOS EN CHECKMK:${NC}"
echo "  üìä Dashboard Principal - Estado general y gr√°ficas de sistema"
echo "  üñ•Ô∏è  System Metrics - M√©tricas detalladas de todos los hosts"
echo "  üöÄ Applications - Estado de aplicaciones y servicios"
echo ""

echo -e "${BOLD}${YELLOW}‚è±Ô∏è  IMPORTANTE - TIEMPO DE ESPERA:${NC}"
echo ""
echo "  Las gr√°ficas en CheckMK tardan en aparecer porque necesita"
echo "  recolectar datos hist√≥ricos primero:"
echo ""
echo "  ‚Ä¢ Primera verificaci√≥n: 1-5 minutos"
echo "  ‚Ä¢ Primeras m√©tricas:    5-10 minutos"
echo "  ‚Ä¢ Gr√°ficas completas:   15-30 minutos"
echo ""
echo -e "${GREEN}  üí° MIENTRAS ESPERAS:${NC}"
echo "     - Usa Grafana para gr√°ficas inmediatas y hermosas"
echo "     - Usa Netdata para monitoreo en tiempo real"
echo ""

echo -e "${BOLD}C√ìMO VER GR√ÅFICAS EN CHECKMK:${NC}"
echo ""
echo "  1. Desde Dashboards:"
echo "     Monitor ‚Üí Dashboards ‚Üí Selecciona un dashboard"
echo ""
echo "  2. Desde un Servicio:"
echo "     Monitor ‚Üí All services ‚Üí Click en servicio"
echo "     Busca la secci√≥n 'Service Metrics'"
echo ""
echo "  3. Vista de Performance:"
echo "     Monitor ‚Üí Performance ‚Üí Selecciona host"
echo ""

echo -e "${BOLD}VERIFICAR ESTADO:${NC}"
echo "  Hosts configurados:  $host_count"
echo "  Servicios activos:   $service_count"
echo ""

echo -e "${BOLD}COMANDOS √öTILES:${NC}"
echo "  ‚Ä¢ Verificar CheckMK:     ./verificar-checkmk.sh"
echo "  ‚Ä¢ Ver logs:              docker logs ensurance-checkmk-full --tail 50"
echo "  ‚Ä¢ Reiniciar CheckMK:     docker restart ensurance-checkmk-full"
echo ""

echo -e "${BOLD}${GREEN}PR√ìXIMOS PASOS:${NC}"
echo ""
echo "  1. Accede a Grafana (http://localhost:3001) para ver gr√°ficas ahora"
echo "  2. Accede a CheckMK y explora los dashboards creados"
echo "  3. Espera 15-30 minutos para que CheckMK recolecte datos"
echo "  4. Vuelve a CheckMK para ver las gr√°ficas completas"
echo ""

echo -e "${BOLD}DOCUMENTACI√ìN:${NC}"
echo "  Lee la gu√≠a completa: ${BLUE}GUIA-GRAFICAS-CHECKMK.md${NC}"
echo ""

# Guardar logs
echo ""
echo "Logs guardados en:"
echo "  - /tmp/checkmk-dashboard-config.log"
echo "  - /tmp/checkmk-graph-config.log"
echo "  - /tmp/checkmk-enable.log"
echo ""

echo -e "${BOLD}${GREEN}‚úÖ ¬°CONFIGURACI√ìN COMPLETADA!${NC}"
echo ""

<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XMLMedicineHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backv5</a> &gt; <a href="index.source.html" class="el_package">com.sources.app.handlers</a> &gt; <span class="el_source">XMLMedicineHandler.java</span></div><h1>XMLMedicineHandler.java</h1><pre class="source lang-java linenums">package com.sources.app.handlers;

import com.sources.app.dao.MedicineDAO;
import com.sources.app.entities.Medicine;
import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;
import java.io.IOException;
import java.io.OutputStream;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Manejador HTTP para obtener una lista de medicamentos en formato XML.
 * Responde a solicitudes GET en el endpoint &quot;/api2/medicines-xml&quot;.
 */
public class XMLMedicineHandler implements HttpHandler {
    private final MedicineDAO medicineDAO;
    private static final String ENDPOINT = &quot;/api2/medicines-xml&quot;;
<span class="fc" id="L21">    private static final Logger LOGGER = Logger.getLogger(XMLMedicineHandler.class.getName());</span>

    /**
     * Constructor para XMLMedicineHandler.
     *
     * @param medicineDAO El DAO para acceder a los datos de los medicamentos.
     */
<span class="fc" id="L28">    public XMLMedicineHandler(MedicineDAO medicineDAO) {</span>
<span class="fc" id="L29">        this.medicineDAO = medicineDAO;</span>
<span class="fc" id="L30">    }</span>

    /**
     * Maneja las solicitudes HTTP entrantes.
     * Configura las cabeceras CORS y delega el manejo según el método HTTP (solo GET soportado).
     *
     * @param exchange El objeto HttpExchange que representa la solicitud y respuesta.
     * @throws IOException Si ocurre un error de entrada/salida.
     */
    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L41">        exchange.getResponseHeaders().add(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span>
<span class="fc" id="L42">        exchange.getResponseHeaders().add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, OPTIONS&quot;);</span>
<span class="fc" id="L43">        exchange.getResponseHeaders().add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, Authorization&quot;);</span>

<span class="fc bfc" id="L45" title="All 2 branches covered.">        if (&quot;OPTIONS&quot;.equalsIgnoreCase(exchange.getRequestMethod())) {</span>
<span class="fc" id="L46">            exchange.sendResponseHeaders(204, -1);</span>
<span class="fc" id="L47">            return;</span>
        }

<span class="fc" id="L50">        String path = exchange.getRequestURI().getPath();</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (!path.startsWith(ENDPOINT)) {</span>
<span class="fc" id="L52">            exchange.sendResponseHeaders(404, -1);</span>
<span class="fc" id="L53">            return;</span>
        }

<span class="fc" id="L56">        String method = exchange.getRequestMethod();</span>
        try {
<span class="fc bfc" id="L58" title="All 2 branches covered.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L59">                handleGet(exchange);</span>
            } else {
<span class="fc" id="L61">                exchange.sendResponseHeaders(405, -1);</span>
            }
<span class="nc" id="L63">        } catch (Exception e) {</span>
<span class="nc" id="L64">            LOGGER.log(Level.SEVERE, &quot;Error processing XMLMedicineHandler request&quot;, e);</span>
<span class="nc" id="L65">            exchange.sendResponseHeaders(500, -1);</span>
<span class="fc" id="L66">        }</span>
<span class="fc" id="L67">    }</span>

    /**
     * Maneja las solicitudes GET.
     * Obtiene todos los medicamentos de la base de datos usando MedicineDAO,
     * los convierte a formato XML y envía la respuesta XML al cliente.
     *
     * @param exchange El objeto HttpExchange.
     * @throws IOException Si ocurre un error de entrada/salida al enviar la respuesta.
     */
    private void handleGet(HttpExchange exchange) throws IOException {
        // Get all medicines from the database
<span class="fc" id="L79">        List&lt;Medicine&gt; medicines = medicineDAO.getAll();</span>
        
        // Convert the list of medicines to XML format
<span class="fc" id="L82">        String xmlResponse = convertToXml(medicines);</span>
        
        // Set response headers
<span class="fc" id="L85">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/xml&quot;);</span>
<span class="fc" id="L86">        byte[] responseBytes = xmlResponse.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L87">        exchange.sendResponseHeaders(200, responseBytes.length);</span>
        
        // Write the response
<span class="fc" id="L90">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="fc" id="L91">            os.write(responseBytes);</span>
        }
<span class="fc" id="L93">    }</span>

    /**
     * Convierte una lista de objetos Medicine a una cadena de texto en formato XML.
     *
     * @param medicines La lista de medicamentos a convertir.
     * @return Una cadena String que representa la lista de medicamentos en formato XML.
     */
    private String convertToXml(List&lt;Medicine&gt; medicines) {
<span class="fc" id="L102">        StringBuilder xml = new StringBuilder();</span>
<span class="fc" id="L103">        xml.append(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&quot;);</span>
<span class="fc" id="L104">        xml.append(&quot;&lt;medicines&gt;\n&quot;);</span>
        
<span class="fc bfc" id="L106" title="All 2 branches covered.">        for (Medicine medicine : medicines) {</span>
<span class="fc" id="L107">            xml.append(&quot;  &lt;medicine&gt;\n&quot;);</span>
<span class="fc" id="L108">            xml.append(&quot;    &lt;idMedicine&gt;&quot;).append(medicine.getIdMedicine()).append(&quot;&lt;/idMedicine&gt;\n&quot;);</span>
<span class="fc" id="L109">            xml.append(&quot;    &lt;name&gt;&quot;).append(escapeXml(medicine.getName())).append(&quot;&lt;/name&gt;\n&quot;);</span>
<span class="fc" id="L110">            xml.append(&quot;    &lt;activeMedicament&gt;&quot;).append(escapeXml(medicine.getActiveMedicament())).append(&quot;&lt;/activeMedicament&gt;\n&quot;);</span>
<span class="fc" id="L111">            xml.append(&quot;    &lt;description&gt;&quot;).append(escapeXml(medicine.getDescription())).append(&quot;&lt;/description&gt;\n&quot;);</span>
<span class="fc" id="L112">            xml.append(&quot;    &lt;image&gt;&quot;).append(escapeXml(medicine.getImage())).append(&quot;&lt;/image&gt;\n&quot;);</span>
<span class="fc" id="L113">            xml.append(&quot;    &lt;concentration&gt;&quot;).append(escapeXml(medicine.getConcentration())).append(&quot;&lt;/concentration&gt;\n&quot;);</span>
<span class="fc" id="L114">            xml.append(&quot;    &lt;presentacion&gt;&quot;).append(medicine.getPresentacion()).append(&quot;&lt;/presentacion&gt;\n&quot;);</span>
<span class="fc" id="L115">            xml.append(&quot;    &lt;stock&gt;&quot;).append(medicine.getStock()).append(&quot;&lt;/stock&gt;\n&quot;);</span>
<span class="fc" id="L116">            xml.append(&quot;    &lt;brand&gt;&quot;).append(escapeXml(medicine.getBrand())).append(&quot;&lt;/brand&gt;\n&quot;);</span>
<span class="fc" id="L117">            xml.append(&quot;    &lt;prescription&gt;&quot;).append(medicine.getPrescription()).append(&quot;&lt;/prescription&gt;\n&quot;);</span>
<span class="fc" id="L118">            xml.append(&quot;    &lt;price&gt;&quot;).append(medicine.getPrice()).append(&quot;&lt;/price&gt;\n&quot;);</span>
<span class="fc" id="L119">            xml.append(&quot;    &lt;soldUnits&gt;&quot;).append(medicine.getSoldUnits()).append(&quot;&lt;/soldUnits&gt;\n&quot;);</span>
<span class="fc" id="L120">            xml.append(&quot;  &lt;/medicine&gt;\n&quot;);</span>
<span class="fc" id="L121">        }</span>
        
<span class="fc" id="L123">        xml.append(&quot;&lt;/medicines&gt;&quot;);</span>
<span class="fc" id="L124">        return xml.toString();</span>
    }
    
    /**
     * Escapa caracteres especiales XML en una cadena de texto.
     * Reemplaza &amp;, &lt;, &gt;, &quot;, ' con sus entidades XML correspondientes.
     *
     * @param input La cadena de texto a escapar.
     * @return La cadena de texto con los caracteres especiales escapados, o una cadena vacía si la entrada es nula.
     */
    private String escapeXml(String input) {
<span class="fc bfc" id="L135" title="All 2 branches covered.">        if (input == null) {</span>
<span class="fc" id="L136">            return &quot;&quot;;</span>
        }
<span class="fc" id="L138">        return input.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)</span>
<span class="fc" id="L139">                   .replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)</span>
<span class="fc" id="L140">                   .replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)</span>
<span class="fc" id="L141">                   .replace(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;)</span>
<span class="fc" id="L142">                   .replace(&quot;'&quot;, &quot;&amp;apos;&quot;);</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>
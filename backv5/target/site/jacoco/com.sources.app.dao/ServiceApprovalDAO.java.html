<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServiceApprovalDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backv5</a> &gt; <a href="index.source.html" class="el_package">com.sources.app.dao</a> &gt; <span class="el_source">ServiceApprovalDAO.java</span></div><h1>ServiceApprovalDAO.java</h1><pre class="source lang-java linenums">package com.sources.app.dao;

import com.sources.app.entities.Hospital;
import com.sources.app.entities.ServiceApproval;
import com.sources.app.entities.User;
import com.sources.app.util.HibernateUtil;
import org.hibernate.Session;
import org.hibernate.Transaction;
import org.hibernate.query.Query;

import java.util.Date;
import java.util.List;
import java.util.UUID;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Data Access Object (DAO) para gestionar entidades {@link ServiceApproval}.
 * Esta clase proporciona métodos para crear, actualizar (estado, detalles de la receta),
 * y consultar aprobaciones de servicio basadas en varios criterios (ID, código de aprobación, usuario, hospital).
 * Utiliza Hibernate para interacciones con la base de datos.
 */
<span class="fc" id="L23">public class ServiceApprovalDAO {</span>

<span class="fc" id="L25">    private static final Logger LOGGER = Logger.getLogger(ServiceApprovalDAO.class.getName());</span>

    /**
     * Crea un nuevo registro de ServiceApproval en la base de datos.
     * Genera automáticamente un código de aprobación único.
     *
     * @param user               El {@link User} asociado con la aprobación.
     * @param hospital           El {@link Hospital} asociado con la aprobación.
     * @param serviceId          El identificador del servicio que se está aprobando.
     * @param serviceName        El nombre del servicio.
     * @param serviceDescription Una descripción del servicio (puede ser null).
     * @param serviceCost        El costo total del servicio.
     * @param coveredAmount      El monto cubierto por el seguro o la póliza.
     * @param patientAmount      El monto a pagar por el paciente.
     * @param status             El estado inicial de la aprobación (p. ej., &quot;PENDIENTE&quot;, &quot;APROBADO&quot;).
     * @return La entidad {@link ServiceApproval} recién creada con su código generado, o null si ocurrió un error.
     */
    public ServiceApproval create(User user, Hospital hospital, String serviceId, String serviceName,
                                String serviceDescription, Double serviceCost, Double coveredAmount,
                                Double patientAmount, String status) {
<span class="fc" id="L45">        Transaction transaction = null;</span>
<span class="fc" id="L46">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L47">            transaction = session.beginTransaction();</span>
            
<span class="fc" id="L49">            ServiceApproval approval = new ServiceApproval();</span>
<span class="fc" id="L50">            approval.setUser(user);</span>
<span class="fc" id="L51">            approval.setHospital(hospital);</span>
<span class="fc" id="L52">            approval.setServiceId(serviceId);</span>
<span class="fc" id="L53">            approval.setServiceName(serviceName);</span>
<span class="fc" id="L54">            approval.setServiceDescription(serviceDescription);</span>
<span class="fc" id="L55">            approval.setServiceCost(serviceCost);</span>
<span class="fc" id="L56">            approval.setCoveredAmount(coveredAmount);</span>
<span class="fc" id="L57">            approval.setPatientAmount(patientAmount);</span>
<span class="fc" id="L58">            approval.setStatus(status);</span>
<span class="fc" id="L59">            approval.setApprovalDate(new Date());</span>
            
            // Generar código de aprobación único
<span class="fc" id="L62">            String approvalCode = generateApprovalCode();</span>
<span class="fc" id="L63">            approval.setApprovalCode(approvalCode);</span>
            
<span class="fc" id="L65">            session.persist(approval);</span>
<span class="fc" id="L66">            transaction.commit();</span>
<span class="fc" id="L67">            return approval;</span>
<span class="nc" id="L68">        } catch (Exception e) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (transaction != null) {</span>
<span class="nc" id="L70">                transaction.rollback();</span>
            }
<span class="nc" id="L72">            LOGGER.log(Level.SEVERE, &quot;Error creating ServiceApproval (serviceId=&quot; + serviceId + &quot;, serviceName=&quot; + serviceName + &quot;)&quot;, e);</span>
<span class="nc" id="L73">            return null;</span>
        }
    }
    
    /**
     * Actualiza la información relacionada con la receta para un ServiceApproval existente.
     *
     * @param approvalId        El ID del registro de ServiceApproval a actualizar.
     * @param prescriptionId    El ID de la receta asociada (puede ser null o actualizado).
     * @param prescriptionTotal El costo total de la receta asociada (puede ser null o actualizado).
     * @return La entidad {@link ServiceApproval} actualizada, o null si no se encontró la aprobación o ocurrió un error.
     */
    public ServiceApproval updatePrescription(Long approvalId, String prescriptionId, Double prescriptionTotal) {
<span class="fc" id="L86">        Transaction transaction = null;</span>
<span class="fc" id="L87">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L88">            transaction = session.beginTransaction();</span>
            
<span class="fc" id="L90">            ServiceApproval approval = session.get(ServiceApproval.class, approvalId);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">            if (approval != null) {</span>
<span class="fc" id="L92">                approval.setPrescriptionId(prescriptionId);</span>
<span class="fc" id="L93">                approval.setPrescriptionTotal(prescriptionTotal);</span>
<span class="fc" id="L94">                session.merge(approval);</span>
<span class="fc" id="L95">                transaction.commit();</span>
<span class="fc" id="L96">                return approval;</span>
            }
<span class="nc" id="L98">            return null;</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">        } catch (Exception e) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (transaction != null) {</span>
<span class="nc" id="L101">                transaction.rollback();</span>
            }
<span class="nc" id="L103">            LOGGER.log(Level.SEVERE, &quot;Error updating prescription fields for ServiceApproval id=&quot; + approvalId, e);</span>
<span class="nc" id="L104">            return null;</span>
        }
    }
    
    /**
     * Actualiza el estado de un ServiceApproval existente.
     * Si el nuevo estado es &quot;RECHAZADO&quot;, se puede proporcionar una razón de rechazo.
     * Si el nuevo estado es &quot;COMPLETADO&quot;, la fecha de finalización se establece automáticamente.
     *
     * @param approvalId      El ID del registro de ServiceApproval a actualizar.
     * @param status          El nuevo estado (p. ej., &quot;APROBADO&quot;, &quot;RECHAZADO&quot;, &quot;COMPLETADO&quot;).
     * @param rejectionReason La razón del rechazo (relevante solo si el estado es &quot;RECHAZADO&quot;, puede ser null).
     * @return La entidad {@link ServiceApproval} actualizada, o null si no se encontró la aprobación o ocurrió un error.
     */
    public ServiceApproval updateStatus(Long approvalId, String status, String rejectionReason) {
<span class="fc" id="L119">        Transaction transaction = null;</span>
<span class="fc" id="L120">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L121">            transaction = session.beginTransaction();</span>
            
<span class="fc" id="L123">            ServiceApproval approval = session.get(ServiceApproval.class, approvalId);</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">            if (approval != null) {</span>
<span class="fc" id="L125">                approval.setStatus(status);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">                if (rejectionReason != null) {</span>
<span class="fc" id="L127">                    approval.setRejectionReason(rejectionReason);</span>
                }
                
<span class="fc bfc" id="L130" title="All 2 branches covered.">                if (&quot;COMPLETED&quot;.equals(status)) {</span>
<span class="fc" id="L131">                    approval.setCompletedDate(new Date());</span>
                }
                
<span class="fc" id="L134">                session.merge(approval);</span>
<span class="fc" id="L135">                transaction.commit();</span>
<span class="fc" id="L136">                return approval;</span>
            }
<span class="nc" id="L138">            return null;</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        } catch (Exception e) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (transaction != null) {</span>
<span class="nc" id="L141">                transaction.rollback();</span>
            }
<span class="nc" id="L143">            LOGGER.log(Level.SEVERE, &quot;Error updating status for ServiceApproval id=&quot; + approvalId + &quot;, newStatus=&quot; + status, e);</span>
<span class="nc" id="L144">            return null;</span>
        }
    }
    
    /**
     * Recupera un registro de ServiceApproval específico por su identificador único.
     *
     * @param id El ID del ServiceApproval a recuperar.
     * @return La entidad {@link ServiceApproval} correspondiente al ID dado, o null si no se encuentra o ocurrió un error.
     */
    public ServiceApproval getById(Long id) {
<span class="fc" id="L155">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L156">            return session.get(ServiceApproval.class, id);</span>
<span class="nc" id="L157">        } catch (Exception e) {</span>
<span class="nc" id="L158">            LOGGER.log(Level.SEVERE, &quot;Error fetching ServiceApproval by id=&quot; + id, e);</span>
<span class="nc" id="L159">            return null;</span>
        }
    }
    
    /**
     * Recupera un registro de ServiceApproval específico por su código de aprobación único.
     *
     * @param approvalCode El código de aprobación único a buscar.
     * @return La entidad {@link ServiceApproval} correspondiente al código dado, o null si no se encuentra o ocurrió un error.
     */
    public ServiceApproval getByApprovalCode(String approvalCode) {
<span class="fc" id="L170">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L171">            Query&lt;ServiceApproval&gt; query = session.createQuery(</span>
                &quot;FROM ServiceApproval WHERE approvalCode = :code&quot;, ServiceApproval.class);
<span class="fc" id="L173">            query.setParameter(&quot;code&quot;, approvalCode);</span>
<span class="fc" id="L174">            return query.uniqueResult();</span>
<span class="nc" id="L175">        } catch (Exception e) {</span>
<span class="nc" id="L176">            LOGGER.log(Level.SEVERE, &quot;Error fetching ServiceApproval by approvalCode=&quot; + approvalCode, e);</span>
<span class="nc" id="L177">            return null;</span>
        }
    }
    
    /**
     * Recupera todos los registros de ServiceApproval asociados con un usuario específico, ordenados por fecha de creación descendente.
     *
     * @param userId El ID del {@link User}.
     * @return Una lista de entidades {@link ServiceApproval} para el usuario especificado, o null si ocurrió un error.
     */
    public List&lt;ServiceApproval&gt; getByUser(Long userId) {
<span class="fc" id="L188">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L189">            Query&lt;ServiceApproval&gt; query = session.createQuery(</span>
                &quot;FROM ServiceApproval WHERE user.idUser = :userId ORDER BY createdAt DESC&quot;, ServiceApproval.class);
<span class="fc" id="L191">            query.setParameter(&quot;userId&quot;, userId);</span>
<span class="fc" id="L192">            return query.list();</span>
<span class="nc" id="L193">        } catch (Exception e) {</span>
<span class="nc" id="L194">            LOGGER.log(Level.SEVERE, &quot;Error fetching ServiceApproval by user id=&quot; + userId, e);</span>
<span class="nc" id="L195">            return null;</span>
        }
    }
    
    /**
     * Recupera todos los registros de ServiceApproval asociados con un hospital específico, ordenados por fecha de creación descendente.
     *
     * @param hospitalId El ID del {@link Hospital}.
     * @return Una lista de entidades {@link ServiceApproval} para el hospital especificado, o null si ocurrió un error.
     */
    public List&lt;ServiceApproval&gt; getByHospital(Long hospitalId) {
<span class="fc" id="L206">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L207">            Query&lt;ServiceApproval&gt; query = session.createQuery(</span>
                &quot;FROM ServiceApproval WHERE hospital.idHospital = :hospitalId ORDER BY createdAt DESC&quot;, ServiceApproval.class);
<span class="fc" id="L209">            query.setParameter(&quot;hospitalId&quot;, hospitalId);</span>
<span class="fc" id="L210">            return query.list();</span>
<span class="nc" id="L211">        } catch (Exception e) {</span>
<span class="nc" id="L212">            LOGGER.log(Level.SEVERE, &quot;Error fetching ServiceApproval by hospital id=&quot; + hospitalId, e);</span>
<span class="nc" id="L213">            return null;</span>
        }
    }
    
    /**
     * Recupera todos los registros de ServiceApproval de la base de datos, ordenados por fecha de creación descendente.
     *
     * @return Una lista de todas las entidades {@link ServiceApproval}, o null si ocurrió un error.
     */
    public List&lt;ServiceApproval&gt; getAll() {
<span class="fc" id="L223">        try (Session session = HibernateUtil.getSessionFactory().openSession()) {</span>
<span class="fc" id="L224">            Query&lt;ServiceApproval&gt; query = session.createQuery(</span>
                &quot;FROM ServiceApproval ORDER BY createdAt DESC&quot;, ServiceApproval.class);
<span class="fc" id="L226">            return query.list();</span>
<span class="nc" id="L227">        } catch (Exception e) {</span>
<span class="nc" id="L228">            LOGGER.log(Level.SEVERE, &quot;Error fetching all ServiceApproval records&quot;, e);</span>
<span class="nc" id="L229">            return null;</span>
        }
    }
    
    /**
     * Genera un código de aprobación único usando una porción de un UUID.
     * El formato del código es &quot;AP&quot; seguido de 8 caracteres hexadecimales en mayúsculas.
     *
     * @return Un código de aprobación String único (p. ej., &quot;AP1A2B3C4D&quot;).
     */
    private String generateApprovalCode() {
        // Generar un UUID y tomar los primeros 8 caracteres
<span class="fc" id="L241">        String uuid = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;).substring(0, 8).toUpperCase();</span>
<span class="fc" id="L242">        return &quot;AP&quot; + uuid;</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>
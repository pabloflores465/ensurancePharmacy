# ============================================================================
# ALERTAS DE SISTEMA - NETDATA
# Ensurance Pharmacy Monitoring System
# ============================================================================
# Estas alertas monitorean CPU, Memoria, Disco y Red
# Las alertas se envían a Prometheus Alertmanager que luego las envía por Email y Slack
# ============================================================================

# ============================================================================
# CPU ALERTS
# ============================================================================

# Alerta: Alto uso de CPU (> 70%)
# Lógica: Si el uso promedio de CPU excede 70% por 2 minutos, enviar alerta WARNING
alarm: netdata_high_cpu_usage
   on: system.cpu
 calc: $system
units: %
every: 30s
 warn: $this > 70
 crit: $this > 90
delay: up 2m down 5m
 info: El uso de CPU del sistema es alto. \
       WARNING cuando > 70%, CRITICAL cuando > 90%. \
       Se envía correo y notificación de Slack cuando el uso de CPU sobrepase el 70%.
   to: sysadmin

# Alerta: CPU saturado (todos los cores al 100%)
alarm: netdata_cpu_saturation
   on: system.cpu
 calc: $system
units: %
every: 10s
 warn: $this > 95
 crit: $this > 98
delay: up 1m down 3m
 info: CPU cercano a saturación completa. Requiere acción inmediata.
   to: sysadmin

# ============================================================================
# MEMORY ALERTS
# ============================================================================

# Alerta: Alto uso de memoria (> 80%)
# Lógica: Si el uso de memoria excede 80% por 2 minutos, enviar alerta WARNING
alarm: netdata_high_memory_usage
   on: system.ram
 calc: ($used * 100) / ($used + $cached + $free + $buffers)
units: %
every: 30s
 warn: $this > 80
 crit: $this > 95
delay: up 2m down 5m
 info: El uso de memoria del sistema es alto. \
       WARNING cuando > 80%, CRITICAL cuando > 95%. \
       Se envía correo y notificación de Slack cuando el uso de memoria sobrepase el 80%.
   to: sysadmin

# Alerta: Memoria disponible muy baja (< 5%)
alarm: netdata_low_available_memory
   on: mem.available
 calc: ($avail * 100) / ($system.ram.used + $system.ram.cached + $system.ram.free + $system.ram.buffers)
units: %
every: 30s
 warn: $this < 10
 crit: $this < 5
delay: up 1m down 3m
 info: Memoria disponible crítica. Riesgo de OOM killer.
   to: sysadmin

# Alerta: Swap en uso activo
alarm: netdata_swap_usage
   on: system.swap
 calc: ($used * 100) / ($used + $free)
units: %
every: 1m
 warn: $this > 20
 crit: $this > 50
delay: up 3m down 10m
 info: El sistema está usando SWAP, lo que indica presión de memoria. \
       WARNING cuando > 20%, CRITICAL cuando > 50%.
   to: sysadmin

# ============================================================================
# DISK ALERTS
# ============================================================================

# Alerta: Alto uso de disco (> 75%)
# Lógica: Si el uso de disco excede 75% por 5 minutos, enviar alerta WARNING
alarm: netdata_high_disk_usage
   on: disk_space._
 calc: $used * 100 / ($avail + $used)
units: %
every: 1m
 warn: $this > 75
 crit: $this > 90
delay: up 5m down 15m
 info: El espacio en disco está por encima del límite. \
       WARNING cuando > 75%, CRITICAL cuando > 90%. \
       Se envía correo y notificación de Slack cuando el uso de disco sobrepase el 75%.
   to: sysadmin

# Alerta: Espacio disponible muy bajo (< 5GB)
alarm: netdata_low_disk_space_gb
   on: disk_space._
 calc: $avail / 1024 / 1024
units: GB
every: 1m
 warn: $this < 10
 crit: $this < 5
delay: up 5m down 15m
 info: Espacio en disco muy bajo en términos absolutos. \
       WARNING < 10GB, CRITICAL < 5GB.
   to: sysadmin

# Alerta: Alta tasa de I/O de disco
alarm: netdata_high_disk_io
   on: disk.io
 calc: $reads + $writes
units: KiB/s
every: 30s
 warn: $this > 50000
 crit: $this > 100000
delay: up 3m down 5m
 info: I/O de disco muy alto, posible cuello de botella. \
       WARNING > 50MB/s, CRITICAL > 100MB/s.
   to: sysadmin

# ============================================================================
# NETWORK ALERTS
# ============================================================================

# Alerta: Alto tráfico de red entrante (> 100 MB/s)
# Lógica: Si el tráfico entrante excede 100 MB/s por 5 minutos, enviar alerta WARNING
alarm: netdata_high_network_receive
   on: net.net
 calc: $received
units: kilobits/s
every: 30s
 warn: $this > 819200
 crit: $this > 1638400
delay: up 5m down 10m
 info: Tráfico de red entrante muy alto. \
       WARNING > 100MB/s (819200 Kbps), CRITICAL > 200MB/s. \
       Se envía correo y notificación de Slack cuando el tráfico entrante sobrepase los 100 MB/s.
   to: sysadmin

# Alerta: Alto tráfico de red saliente (> 100 MB/s)
alarm: netdata_high_network_transmit
   on: net.net
 calc: $sent
units: kilobits/s
every: 30s
 warn: $this > 819200
 crit: $this > 1638400
delay: up 5m down 10m
 info: Tráfico de red saliente muy alto. \
       WARNING > 100MB/s (819200 Kbps), CRITICAL > 200MB/s. \
       Se envía correo y notificación de Slack cuando el tráfico saliente sobrepase los 100 MB/s.
   to: sysadmin

# Alerta: Paquetes perdidos en red
alarm: netdata_network_packet_drops
   on: net.drops
 calc: $inbound + $outbound
units: packets/s
every: 30s
 warn: $this > 10
 crit: $this > 100
delay: up 2m down 5m
 info: Se están perdiendo paquetes en la red. \
       Posible congestión o problema de hardware.
   to: sysadmin

# ============================================================================
# LOAD AVERAGE ALERTS
# ============================================================================

# Alerta: Alta carga del sistema (Load Average > 2x CPUs)
# Lógica: Si el load average de 5 minutos excede 2 veces el número de CPUs
alarm: netdata_high_system_load
   on: system.load
 calc: $load5
units: load
every: 30s
 warn: $this > (($system.cpu.cores) * 2)
 crit: $this > (($system.cpu.cores) * 4)
delay: up 5m down 10m
 info: Load average alto indica que el sistema está sobrecargado. \
       WARNING cuando > 2x CPUs, CRITICAL cuando > 4x CPUs. \
       Se envía correo y notificación de Slack cuando la carga sobrepase 2 veces el número de CPUs.
   to: sysadmin

# ============================================================================
# PROCESS ALERTS
# ============================================================================

# Alerta: Demasiados procesos en ejecución
alarm: netdata_too_many_processes
   on: system.active_processes
 calc: $active
units: processes
every: 1m
 warn: $this > 1000
 crit: $this > 5000
delay: up 5m down 10m
 info: Número excesivo de procesos activos en el sistema.
   to: sysadmin

# ============================================================================
# SYSTEM UPTIME
# ============================================================================

# Alerta: Sistema reiniciado recientemente
alarm: netdata_system_rebooted
   on: system.uptime
 calc: $uptime
units: seconds
every: 1m
 warn: $this < 300
 info: El sistema se reinició hace menos de 5 minutos. \
       Verificar que todos los servicios se hayan iniciado correctamente.
   to: sysadmin

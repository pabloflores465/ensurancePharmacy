# ============================================================================
# CI/CD PIPELINE ALERTS - NETDATA
# Ensurance Pharmacy Monitoring System
# ============================================================================
# Estas alertas monitorean procesos de CI/CD: Jenkins, Drone, SonarQube
# Las alertas se envían a Prometheus Alertmanager que luego las envía por Email y Slack
# ============================================================================

# ============================================================================
# JENKINS PROCESS ALERTS
# ============================================================================

# Alerta: Jenkins proceso con alto uso de memoria
# Lógica: Si Jenkins usa más de 2GB de memoria por 5 minutos
alarm: netdata_jenkins_high_memory
   on: apps.mem
 calc: $jenkins
units: MB
every: 1m
 warn: $this > 2048
 crit: $this > 4096
delay: up 5m down 10m
 info: Jenkins está usando mucha memoria. \
       WARNING > 2GB, CRITICAL > 4GB. \
       Se envía correo y notificación de Slack cuando Jenkins use más de 2GB de memoria.
   to: sysadmin

# Alerta: Jenkins proceso con alto uso de CPU
# Lógica: Si Jenkins usa más del 70% de CPU por 3 minutos
alarm: netdata_jenkins_high_cpu
   on: apps.cpu
 calc: $jenkins
units: %
every: 1m
 warn: $this > 70
 crit: $this > 90
delay: up 3m down 5m
 info: Jenkins está usando mucho CPU. \
       WARNING > 70%, CRITICAL > 90%. \
       Se envía correo y notificación de Slack cuando Jenkins use más del 70% de CPU.
   to: sysadmin

# Alerta: Demasiados procesos Jenkins worker
alarm: netdata_jenkins_too_many_workers
   on: apps.processes
 calc: $jenkins
units: processes
every: 1m
 warn: $this > 20
 crit: $this > 50
delay: up 5m down 10m
 info: Demasiados procesos worker de Jenkins. Posible problema de builds colgados.
   to: sysadmin

# ============================================================================
# SONARQUBE PROCESS ALERTS
# ============================================================================

# Alerta: SonarQube proceso con alto uso de memoria
alarm: netdata_sonarqube_high_memory
   on: apps.mem
 calc: $sonarqube
units: MB
every: 1m
 warn: $this > 2048
 crit: $this > 4096
delay: up 5m down 10m
 info: SonarQube usando mucha memoria. \
       WARNING > 2GB, CRITICAL > 4GB. \
       Se envía correo y notificación de Slack cuando SonarQube use más de 2GB.
   to: sysadmin

# Alerta: SonarQube proceso con alto uso de CPU
alarm: netdata_sonarqube_high_cpu
   on: apps.cpu
 calc: $sonarqube
units: %
every: 1m
 warn: $this > 70
 crit: $this > 90
delay: up 3m down 5m
 info: SonarQube usando mucho CPU durante análisis. \
       Se envía correo y notificación de Slack cuando SonarQube use más del 70% de CPU.
   to: sysadmin

# ============================================================================
# DOCKER DAEMON ALERTS (para builds)
# ============================================================================

# Alerta: Docker daemon con alto uso de CPU
alarm: netdata_docker_high_cpu
   on: apps.cpu
 calc: $dockerd
units: %
every: 1m
 warn: $this > 70
 crit: $this > 90
delay: up 3m down 5m
 info: Docker daemon usando mucho CPU. Posible build o test pesado. \
       Se envía correo y notificación de Slack cuando Docker use más del 70% de CPU.
   to: sysadmin

# Alerta: Docker daemon con alto uso de memoria
alarm: netdata_docker_high_memory
   on: apps.mem
 calc: $dockerd
units: MB
every: 1m
 warn: $this > 2048
 crit: $this > 4096
delay: up 5m down 10m
 info: Docker daemon usando mucha memoria. \
       Se envía correo y notificación de Slack cuando Docker use más de 2GB.
   to: sysadmin

# ============================================================================
# GIT PROCESS ALERTS
# ============================================================================

# Alerta: Muchos procesos git corriendo
alarm: netdata_many_git_processes
   on: apps.processes
 calc: $git
units: processes
every: 1m
 warn: $this > 10
 crit: $this > 20
delay: up 3m down 5m
 info: Muchos procesos git corriendo simultáneamente. \
       Posible problema con clones o fetches.
   to: sysadmin

# ============================================================================
# BUILD ARTIFACT DISK USAGE
# ============================================================================

# Alerta: Directorio de builds con mucho espacio usado
# Nota: Requiere configuración específica de path en Netdata
alarm: netdata_build_artifacts_disk_usage
   on: disk_space._var_lib_jenkins
 calc: $used * 100 / ($avail + $used)
units: %
every: 5m
 warn: $this > 75
 crit: $this > 90
delay: up 10m down 30m
 info: Directorio de artifacts de builds con mucho espacio usado. \
       Limpiar builds antiguos. \
       Se envía correo y notificación de Slack cuando use más del 75%.
   to: sysadmin

# ============================================================================
# MONITORING TOOLS HEALTH
# ============================================================================

# Alerta: Prometheus proceso con alto uso de memoria
alarm: netdata_prometheus_high_memory
   on: apps.mem
 calc: $prometheus
units: MB
every: 1m
 warn: $this > 2048
 crit: $this > 4096
delay: up 5m down 10m
 info: Prometheus usando mucha memoria. \
       WARNING > 2GB, CRITICAL > 4GB. \
       Se envía correo y notificación de Slack cuando use más de 2GB.
   to: sysadmin

# Alerta: Grafana proceso con alto uso de memoria
alarm: netdata_grafana_high_memory
   on: apps.mem
 calc: $grafana
units: MB
every: 1m
 warn: $this > 1024
 crit: $this > 2048
delay: up 5m down 10m
 info: Grafana usando mucha memoria. \
       Se envía correo y notificación de Slack cuando use más de 1GB.
   to: sysadmin

# ============================================================================
# CONTAINER REGISTRY ALERTS (si aplica)
# ============================================================================

# Alerta: Registry con alto uso de disco
alarm: netdata_registry_disk_usage
   on: disk_space._var_lib_docker
 calc: $used * 100 / ($avail + $used)
units: %
every: 5m
 warn: $this > 75
 crit: $this > 90
delay: up 10m down 30m
 info: Docker registry/volumes usando mucho espacio. \
       Limpiar imágenes antiguas. \
       Se envía correo y notificación de Slack cuando use más del 75%.
   to: sysadmin

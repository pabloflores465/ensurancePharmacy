# Alertmanager Configuration - Ensurance Pharmacy
# ARCHIVO GENERADO AUTOM√ÅTICAMENTE - NO EDITAR MANUALMENTE
# Edita .env.alertmanager y ejecuta ./setup-alertmanager-secrets.sh

global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'rfloresm@unis.edu.gt'
  smtp_auth_username: 'rfloresm@unis.edu.gt'
  smtp_auth_password: 'gmxaibrzxakzlnct'
  smtp_require_tls: true

route:
  receiver: 'default-notifications'
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 3h
  group_by: ['alertname', 'cluster', 'service']
  
  routes:
    # Alertas de aplicaciones ca√≠das - Cada 2 horas para evitar spam
    - match_re:
        alertname: '(PharmacyBackendDown|EnsuranceBackendDown|EnsuranceFrontendDown|PharmacyFrontendDown)'
      receiver: 'critical-notifications'
      group_wait: 0s
      repeat_interval: 2h
      continue: false
    
    # Otras alertas cr√≠ticas - Cada 5 minutos
    - match:
        severity: critical
      receiver: 'critical-notifications'
      group_wait: 0s
      repeat_interval: 5m
      
    - match:
        severity: warning
      receiver: 'warning-notifications'
      repeat_interval: 1h
      
    - match:
        severity: info
      receiver: 'info-notifications'
      repeat_interval: 6h

receivers:
  - name: 'default-notifications'
    email_configs:
      - to: 'pablopolis2016@gmail.com,jflores@unis.edu.gt'
        headers:
          Subject: '[Ensurance Pharmacy] Alerta de Monitoreo'
        html: |
          <h2>Alerta de Monitoreo - Ensurance Pharmacy</h2>
          <p><strong>Estado:</strong> {{ .Status }}</p>
          <p><strong>Severidad:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Alerta:</strong> {{ .CommonLabels.alertname }}</p>
          <p><strong>Descripci√≥n:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>Resumen:</strong> {{ .CommonAnnotations.summary }}</p>
          <p><strong>Tiempo:</strong> {{ .StartsAt }}</p>
          <hr>
          <p><em>Sistema de Monitoreo Autom√°tico - Ensurance Pharmacy</em></p>
    slack_configs:
      - api_url: 'SLACK_WEBHOOK_URL_AQUI'
        channel: '#ensurance-alerts'
        title: 'Alerta de Monitoreo - Ensurance Pharmacy'
        text: |
          *Estado:* {{ .Status }}
          *Severidad:* {{ .CommonLabels.severity }}
          *Alerta:* {{ .CommonLabels.alertname }}
          *Descripci√≥n:* {{ .CommonAnnotations.description }}
          *Resumen:* {{ .CommonAnnotations.summary }}
          *Tiempo:* {{ .StartsAt }}
          *Servicio:* {{ .CommonLabels.service }}
        send_resolved: true
  
  - name: 'critical-notifications'
    email_configs:
      - to: 'pablopolis2016@gmail.com,jflores@unis.edu.gt'
        headers:
          Subject: 'üî¥ [CR√çTICO] Alerta Urgente - Ensurance Pharmacy'
        html: |
          <div style="background-color: #ff0000; color: white; padding: 20px;">
            <h1>‚ö†Ô∏è ALERTA CR√çTICA ‚ö†Ô∏è</h1>
          </div>
          <h2>Ensurance Pharmacy - Acci√≥n Inmediata Requerida</h2>
          <p><strong>üî¥ Severidad:</strong> CR√çTICO</p>
          <p><strong>üìõ Alerta:</strong> {{ .CommonLabels.alertname }}</p>
          <p><strong>üìù Descripci√≥n:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>üí° Resumen:</strong> {{ .CommonAnnotations.summary }}</p>
          <p><strong>üïê Inicio:</strong> {{ .StartsAt }}</p>
          <p><strong>üéØ Servicio:</strong> {{ .CommonLabels.service }}</p>
          <p><strong>üñ•Ô∏è Instancia:</strong> {{ .CommonLabels.instance }}</p>
          <hr>
          <p style="color: red;"><strong>‚ö° ACCI√ìN REQUERIDA INMEDIATAMENTE</strong></p>
          <p><em>Sistema de Monitoreo Cr√≠tico - Ensurance Pharmacy</em></p>
    slack_configs:
      - api_url: 'SLACK_WEBHOOK_URL_AQUI'
        channel: '#ensurance-alerts'
        username: 'Alertmanager'
        icon_emoji: ':rotating_light:'
        title: 'üî¥ ALERTA CR√çTICA - Ensurance Pharmacy'
        text: |
          <!channel>
          *‚ö†Ô∏è ALERTA CR√çTICA - ACCI√ìN INMEDIATA REQUERIDA ‚ö†Ô∏è*
          
          *Alerta:* {{ .CommonLabels.alertname }}
          *Severidad:* CR√çTICO
          *Descripci√≥n:* {{ .CommonAnnotations.description }}
          *Resumen:* {{ .CommonAnnotations.summary }}
          *Inicio:* {{ .StartsAt }}
          *Servicio:* {{ .CommonLabels.service }}
          *Instancia:* {{ .CommonLabels.instance }}
          
          *Dashboard:* {{ .CommonAnnotations.dashboard }}
          *Acci√≥n:* {{ .CommonAnnotations.action }}
        send_resolved: true
        color: 'danger'
  
  - name: 'warning-notifications'
    email_configs:
      - to: 'pablopolis2016@gmail.com,jflores@unis.edu.gt'
        headers:
          Subject: '‚ö†Ô∏è [WARNING] Alerta de Monitoreo - Ensurance Pharmacy'
        html: |
          <div style="background-color: #ffa500; color: white; padding: 20px;">
            <h2>‚ö†Ô∏è Advertencia de Monitoreo</h2>
          </div>
          <h2>Ensurance Pharmacy</h2>
          <p><strong>‚ö†Ô∏è Severidad:</strong> WARNING</p>
          <p><strong>üìõ Alerta:</strong> {{ .CommonLabels.alertname }}</p>
          <p><strong>üìù Descripci√≥n:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>üí° Resumen:</strong> {{ .CommonAnnotations.summary }}</p>
          <p><strong>üïê Inicio:</strong> {{ .StartsAt }}</p>
          <p><strong>üéØ Servicio:</strong> {{ .CommonLabels.service }}</p>
          <hr>
          <p><em>Sistema de Monitoreo - Ensurance Pharmacy</em></p>
    slack_configs:
      - api_url: 'SLACK_WEBHOOK_URL_AQUI'
        channel: '#ensurance-alerts'
        username: 'Alertmanager'
        icon_emoji: ':warning:'
        title: '‚ö†Ô∏è WARNING - Ensurance Pharmacy'
        text: |
          *‚ö†Ô∏è Advertencia de Monitoreo*
          
          *Alerta:* {{ .CommonLabels.alertname }}
          *Severidad:* WARNING
          *Descripci√≥n:* {{ .CommonAnnotations.description }}
          *Resumen:* {{ .CommonAnnotations.summary }}
          *Inicio:* {{ .StartsAt }}
          *Servicio:* {{ .CommonLabels.service }}
          
          *Dashboard:* {{ .CommonAnnotations.dashboard }}
          *Acci√≥n:* {{ .CommonAnnotations.action }}
        send_resolved: true
        color: 'warning'
  
  - name: 'info-notifications'
    email_configs:
      - to: 'pablopolis2016@gmail.com,jflores@unis.edu.gt'
        headers:
          Subject: '‚ÑπÔ∏è [INFO] Notificaci√≥n - Ensurance Pharmacy'
        html: |
          <h2>Notificaci√≥n Informativa - Ensurance Pharmacy</h2>
          <p><strong>‚ÑπÔ∏è Severidad:</strong> INFO</p>
          <p><strong>üìõ Alerta:</strong> {{ .CommonLabels.alertname }}</p>
          <p><strong>üìù Descripci√≥n:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>üïê Tiempo:</strong> {{ .StartsAt }}</p>
          <hr>
          <p><em>Sistema de Monitoreo - Ensurance Pharmacy</em></p>
    slack_configs:
      - api_url: 'SLACK_WEBHOOK_URL_AQUI'
        channel: '#ensurance-alerts'
        username: 'Alertmanager'
        icon_emoji: ':information_source:'
        title: '‚ÑπÔ∏è INFO - Ensurance Pharmacy'
        text: |
          *‚ÑπÔ∏è Notificaci√≥n Informativa*
          
          *Alerta:* {{ .CommonLabels.alertname }}
          *Severidad:* INFO
          *Descripci√≥n:* {{ .CommonAnnotations.description }}
          *Tiempo:* {{ .StartsAt }}
          *Servicio:* {{ .CommonLabels.service }}
        send_resolved: true
        color: 'good'

inhibit_rules:
  - source_match:
      severity: 'critical'
      alertname: 'InstanceDown'
    target_match:
      severity: 'warning'
    equal: ['instance']
  
  - source_match:
      severity: 'critical'
      alertname: 'HighCPUUsage'
    target_match:
      alertname: 'HighCPUUsage'
      severity: 'warning'
    equal: ['instance']
